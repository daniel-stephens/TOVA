<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TOVA — Train & Manage Topic Models</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background-color: #f8f9fa; }
    .form-check-input {
      width: 1.2em; height: 1.2em; border: 2px solid #6c757d;
      background-color: #f8f9fa; transition: all 0.2s ease-in-out;
    }
    .form-check-input:hover { border-color: #0d6efd; background-color: #e9ecef; cursor: pointer; }
    .form-check-input:checked { background-color: #076bce; border-color: #215dc5; }
    .form-check-input:focus { box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25); }
    .card-title { font-size: 1.1rem; }
    .model-meta { font-size: 0.9rem; color: #343a40; }
    .badge { font-size: 0.8rem; }
    .sticky-header { position: sticky; top: 0; z-index: 1; background: #fff; }
  </style>
</head>

<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">TOVA</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
        aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-between" id="navbarContent">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/' %} active{% endif %}" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if 'model' in request.path %} active{% endif %}" href="/model">Train Models</a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if 'trained-models' in request.path %} active{% endif %}" href="/trained-models">View Models</a>
          </li>
        </ul>
        <button class="btn btn-sm btn-outline-secondary ms-3" onclick="history.back()">Back</button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <div class="container py-4">
    <style>
      /* Layout */
      .panel-card { height: 100%; display: flex; flex-direction: column; }
      .panel-card .card-header { padding: .5rem .75rem; }
      .panel-card .card-body {
        /* 3-row grid: controls / list / footer */
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: .75rem;
        padding: .75rem .75rem 1rem;
        min-height: 0; /* allow inner scroll area to shrink */
      }
  
      /* Equal-height columns */
      .equal-row { align-items: stretch; }
  
      /* Scrollable list fills the middle row */
      .scroll-area {
        min-height: 0;        /* critical for grid children */
        overflow: auto;
        border: 1px solid #eaecef;
        border-radius: .5rem;
        /* Clamp height to viewport without leaving big gaps */
        height: clamp(260px, calc(100vh - 280px), 65vh);
        background: #fff;
      }
  
      /* Sticky table header + denser rows */
      .table thead th { position: sticky; top: 0; z-index: 1; background: #f8f9fa; }
      .table-sm td, .table-sm th { padding: .35rem .5rem; }
  
      /* Inputs */
      .form-check-input { width: 1.1em; height: 1.1em; border: 2px solid #6c757d; }
      .form-check-input:hover { border-color: #0d6efd; background-color: #e9ecef; cursor: pointer; }
      .form-check-input:checked { background-color: #076bce; border-color: #215dc5; }
  
      /* Titles */
      .panel-section-title { font-size: 1rem; letter-spacing: .2px; margin: 0; }
  
      /* Model cards equal height inside their grid */
      .model-card { display: flex; flex-direction: column; height: 100%; border: 1px solid #e2e6ea; }
      .model-card .card-body { display: flex; flex-direction: column; justify-content: space-between; }
    </style>
  
    <div class="row g-4 equal-row">
      <!-- Left: Corpora & Training -->
      <div class="col-lg-6">
        <div class="card shadow-sm panel-card">
          <div class="card-header bg-white border-0">
            <h5 class="panel-section-title">
              <i class="bi bi-database-check me-2 text-primary"></i>
              Corpora & Training
              <small class="text-muted ms-2">Select one or more corpora</small>
            </h5>
          </div>
  
          <div class="card-body">
            <!-- Row 1: controls -->
            <form id="modelSelectionForm" class="contents" novalidate>
              <div class="mb-2">
                <label for="model_type" class="form-label fw-bold mb-1">Model Type</label>
                <select class="form-select form-select-sm" id="model_type" name="model_type">
                  <option selected disabled>Loading models...</option>
                </select>
              </div>
  
              <!-- Row 2: scrollable list (fills space) -->
              <div class="mb-2">
                <label class="form-label fw-bold mb-1">Choose Corpora</label>
                <div class="scroll-area">
                  <table class="table table-hover table-sm mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th scope="col" style="width: 72px;">Select</th>
                        <th scope="col">Corpus Name</th>
                        <th scope="col" style="width: 120px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="corpusCheckboxTable">
                      <tr><td colspan="3"><em>Loading...</em></td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
  
              <!-- Row 3: footer actions pinned to bottom by grid -->
              <div class="d-flex justify-content-end pt-1">
                <button id="trainBtn" type="submit" disabled class="btn btn-primary">
                  <i class="bi bi-cpu me-1"></i>Train Model
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
  
      <!-- Right: Trained Models -->
      <div class="col-lg-6">
        <div class="card shadow-sm panel-card">
          <div class="card-header bg-white border-0">
            <h5 class="panel-section-title">
              <i class="bi bi-graph-up-arrow me-2 text-success"></i>
              Trained Models
              <small class="text-muted ms-2">Manage & use your trained models</small>
            </h5>
          </div>
  
          <div class="card-body">
            <!-- Middle row fills height -->
            <div class="scroll-area p-2">
              <div id="trainedModelsGrid" class="row row-cols-1 row-cols-sm-2 g-3">
                <div class="col-12 text-center text-muted py-3">
                  <em>Loading trained models…</em>
                </div>
              </div>
            </div>
  
            <!-- (Optional) footer actions could go here -->
            <div style="height: .25rem;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
   <!-- /container -->

  <!-- Model Name Modal -->
  <div class="modal fade" id="modelNameModal" tabindex="-1" aria-labelledby="modelNameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content shadow-lg border-0">
        <div class="modal-header">
          <h5 class="modal-title" id="modelNameModalLabel">Configure & Save Model</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <h6 class="fw-bold mb-3">Basic Settings</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="modelNameInput" class="form-label">Model Name</label>
              <input type="text" id="modelNameInput" class="form-control" placeholder="Enter model name..." required>
              <div id="nameWarning" class="form-text text-danger" style="display: none;">
                This model name already exists. Please choose a different name.
              </div>
            </div>
            <div class="col-md-6" id="topicCountGroupModal">
              <label for="numTopics" class="form-label">Number of Topics</label>
              <input type="number" class="form-control" id="numTopicsModal" value="10" min="2" max="100">
            </div>
          </div>

          <div class="mb-3 text-center mt-3">
            <button class="btn btn-outline-primary btn-sm" type="button" id="toggleAdvanced">
              Show Advanced Settings
            </button>
          </div>

          <div id="advancedSettings" style="display: none;">
            <div class="border rounded p-3 bg-light">
              <h6 class="fw-bold mb-3">Advanced Settings</h6>
              <div id="modelParamsArea" class="row g-3"></div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="confirmModelName">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script>
    /* =========================
       Global state
    ========================= */
    let modelConfig = {};

    /* =========================
       Helpers
    ========================= */
    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, m => (
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
      ));
    }
    async function ensureModelConfigLoaded() {
      if (Object.keys(modelConfig || {}).length) return;
      await loadModelConfig();
    }

    /* =========================
       Boot
    ========================= */
    document.addEventListener("DOMContentLoaded", async () => {
      const modelSelect     = document.getElementById('model_type');
      const topicGroup      = document.getElementById('topicCountGroup');
      const formEl          = document.getElementById('modelSelectionForm');
      const modalEl         = document.getElementById('modelNameModal');
      const confirmBtn      = document.getElementById('confirmModelName');
      const trainBtn        = document.getElementById('trainBtn');

      // Load dropdown + corpuses + config
      await loadModelOptions();
      await loadCorpusCheckboxTable();
      loadModelConfig();            // fire-and-forget; also guarded before opening modal
      initAdvancedToggle();

      // Toggle topics input visibility based on model
      const syncTopicsVisibility = () => {
        const isExternal = (modelSelect?.value === 'External');
        if (topicGroup) topicGroup.style.display = isExternal ? 'none' : 'block';
        // Also mirror to modal's count group input
        document.getElementById('topicCountGroupModal')?.classList.toggle('d-none', isExternal);
      };
      modelSelect?.addEventListener('change', syncTopicsVisibility);
      syncTopicsVisibility();

      // Submit => open modal
      const modal = new bootstrap.Modal(modalEl);
      formEl?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Must have at least one corpus selected
        const chosen = document.querySelectorAll('.corpus-check:checked');
        if (!chosen.length) {
          trainBtn?.classList.add("disabled");
          setTimeout(() => trainBtn?.classList.remove("disabled"), 400);
          return;
        }

        await ensureModelConfigLoaded();
        renderParamsIntoModal(modelSelect.value);

        // Copy main topics value to modal field for convenience
        const nt = document.getElementById('numTopics')?.value ?? '10';
        const ntModal = document.getElementById('numTopicsModal');
        if (ntModal) ntModal.value = nt;

        // Stash selected corpuses for confirm
        window.__selectedCorpuses = Array.from(chosen).map(cb => ({
          id: cb.dataset.id,
          name: cb.dataset.name,
          isDraft: cb.dataset.draft === "1"
        }));

        modal.show();
      });

      // Focus model name once modal opens
      modalEl?.addEventListener('shown.bs.modal', () => {
        document.getElementById('modelNameInput')?.focus();
      });

      // Confirm => stash + redirect
      confirmBtn?.addEventListener('click', () => {
        const modelName  = document.getElementById('modelNameInput')?.value?.trim();
        const numTopics  = document.getElementById('numTopicsModal')?.value?.trim();
        const isExternal = (modelSelect?.value === 'External');

        if (!modelName) { alert("Please provide a model name."); return; }
        if (!window.__selectedCorpuses?.length) { alert("Please select at least one corpus."); return; }

        // Collect advanced params
        const training_params = {};
        document.querySelectorAll("#modelParamsArea input").forEach(input => {
          const key = input.id;
          const value = input.value;
          training_params[key] = input.type === "number" ? Number(value) : value;
        });

        if (!isExternal) training_params["num_topics"] = Number(numTopics || 10);

        const payload = {
          model: modelSelect?.value,
          save_name: modelName,
          training_params,
          corpuses: window.__selectedCorpuses
        };

        sessionStorage.setItem("modelTrainingData", JSON.stringify(payload));

        const query = new URLSearchParams({
          modelName,
          numTopics: isExternal ? "" : (training_params["num_topics"] ?? ""),
          corpuses: window.__selectedCorpuses.map(c => c.name).join(",")
        });
        window.location.href = `/training/?${query.toString()}`;
      });
    });

    /* =========================
       Model registry
    ========================= */
    async function loadModelOptions() {
      const select = document.getElementById("model_type");
      if (!select) return;
      try {
        const res = await fetch("/model-registry");
        if (!res.ok) throw new Error(`registry load failed: ${res.status}`);
        const models = await res.json();

        select.innerHTML = "";
        for (const [key] of Object.entries(models || {})) {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = key;
          select.appendChild(option);
        }
        if (!select.options.length) {
          select.innerHTML = "<option disabled>No models available</option>";
        }
      } catch (err) {
        console.error("Error loading model options:", err);
        select.innerHTML = "<option disabled>Error loading models</option>";
      }
    }

    /* =========================
       Corpuses (drafts + saved)
    ========================= */
    async function fetchAllCorpuses() {
      const res = await fetch("/getallcorpuses", { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error(`Failed to load corpuses: ${res.status}`);
      const items = await res.json();
      // Expect [{id, name, is_draft, created_at}]
      return Array.isArray(items) ? items : [];
    }

    async function loadCorpusCheckboxTable() {
      const tbody = document.getElementById("corpusCheckboxTable");
      const trainBtn = document.getElementById("trainBtn");
      if (!tbody) return;

      tbody.innerHTML = `<tr><td colspan="3"><em>Loading...</em></td></tr>`;

      try {
        const items = await fetchAllCorpuses();

        if (!items.length) {
          tbody.innerHTML = `<tr><td colspan="3"><em>No corpuses found.</em></td></tr>`;
          if (trainBtn) trainBtn.disabled = true;
          return;
        }

        const rows = items.map((it, idx) => {
          const safeName = escapeHtml(it.name || "");
          const badge = it.is_draft ? `<span class="badge rounded-pill text-bg-warning ms-2">Draft</span>` : "";
          const id = `corpus_${idx}`;

          const deleteBtn = it.is_draft
            ? `<button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Drafts cannot be deleted">Delete</button>`
            : `<button type="button" class="btn btn-sm btn-outline-danger" data-delete="${safeName}">Delete</button>`;

          return `
            <tr>
              <td class="text-center">
                <input
                  type="checkbox"
                  class="form-check-input corpus-check"
                  id="${id}"
                  name="corpus"
                  data-id="${escapeHtml(it.id || '')}"
                  data-name="${safeName}"
                  data-draft="${it.is_draft ? '1' : '0'}"
                >
              </td>
              <td>
                <label class="ms-1 mb-0" for="${id}">${safeName}${badge}</label>
              </td>
              <td class="text-end">
                ${deleteBtn}
              </td>
            </tr>`;
        });

        tbody.innerHTML = rows.join("");

        // Enable Train only if at least one selected
        const updateTrain = () => {
          const anyChecked = document.querySelectorAll('.corpus-check:checked').length > 0;
          if (trainBtn) trainBtn.disabled = !anyChecked;
        };
        document.querySelectorAll('.corpus-check').forEach(cb => cb.addEventListener("change", updateTrain));
        updateTrain();

        // Wire delete buttons (only for non-drafts)
        tbody.querySelectorAll('button[data-delete]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const name = btn.getAttribute('data-delete');
            await deleteCorpus(name);
          });
        });

      } catch (e) {
        console.error("Error loading corpuses:", e);
        tbody.innerHTML = `<tr><td colspan="3" class="text-danger"><em>Failed to load corpuses.</em></td></tr>`;
        if (trainBtn) trainBtn.disabled = true;
      }
    }

    /* =========================
       Delete corpus (saved only)
    ========================= */
    async function deleteCorpus(name) {
      if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

      try {
        const res = await fetch(`/delete-corpus/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ corpus_name: name })
        });
        const data = await res.json();

        if (!res.ok) {
          console.error("Server responded with error:", data);
          alert(`Error: ${data.message || 'Delete failed'}`);
          return;
        }

        alert(data.message || "Deleted.");
        loadCorpusCheckboxTable(); // reload table
      } catch (err) {
        console.error("Fetch failed:", err);
        alert("Failed to delete the corpus.");
      }
    }

    /* =========================
       Model config (YAML)
    ========================= */
    async function loadModelConfig() {
      try {
        const res = await fetch("/static/config/config.yaml");
        if (!res.ok) throw new Error(`config load failed: ${res.status}`);
        const yamlText = await res.text();
        modelConfig = (window.jsyaml ? window.jsyaml.load(yamlText) : {}) || {};
      } catch (error) {
        console.error("Error loading model config:", error);
        modelConfig = {};
      }
    }

    /* =========================
       Advanced toggle
    ========================= */
    function initAdvancedToggle() {
      const toggleButton = document.getElementById("toggleAdvanced");
      const advancedSection = document.getElementById("advancedSettings");
      if (!toggleButton || !advancedSection) return;

      toggleButton.addEventListener("click", () => {
        const visible = (advancedSection.style.display === "block");
        advancedSection.style.display = visible ? "none" : "block";
        toggleButton.textContent = visible ? "Show Advanced Settings" : "Hide Advanced Settings";
      });
    }

    /* =========================
       Render params into modal
       Expects: modelConfig.topic_modeling[model]
    ========================= */
    function renderParamsIntoModal(model) {
      const container = document.getElementById('modelParamsArea');
      if (!container) return;
      container.innerHTML = '';

      const paramsRoot = (modelConfig && modelConfig.topic_modeling) || {};
      const params = paramsRoot?.[model];
      if (!params) return;

      for (const key of Object.keys(params)) {
        const value = params[key];

        const col = document.createElement('div');
        col.className = 'col-md-6';

        const label = document.createElement('label');
        label.textContent = key.replace(/_/g, " ");
        label.setAttribute('for', key);
        label.classList.add('form-label');

        const input = document.createElement('input');
        input.type = (typeof value === 'number') ? 'number' : 'text';
        input.className = 'form-control';
        input.id = key;
        input.name = key;
        input.value = value ?? '';

        col.appendChild(label);
        col.appendChild(input);
        container.appendChild(col);
      }
    }

    /* =========================
       Trained models actions
    ========================= */
    function deleteModel(modelId, modelName) {
      if (!confirm("Are you sure you want to delete this model?")) return;

      fetch('/delete-model', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model_id: modelId, model_name: modelName })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Deleted.");
        location.reload();
      })
      .catch(err => {
        console.error("Delete failed:", err);
        alert("Failed to delete model.");
      });
    }

    // Use Model button handlers (delegated if needed)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.use-model-btn');
      if (!btn) return;
      const modelId = btn.getAttribute('data-model-id');
      const modelName = btn.getAttribute('data-model-name');

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/dashboard/${encodeURIComponent(modelName)}`;

      const inputId = document.createElement('input');
      inputId.type = 'hidden';
      inputId.name = 'model_id';
      inputId.value = modelId;
      form.appendChild(inputId);

      document.body.appendChild(form);
      form.submit();
    
    // ---------- Config ----------
    const TRAINED_MODELS_ENDPOINT = "/get-trained-models";   // change if your JSON route differs
    const DELETE_MODEL_ENDPOINT   = "/delete-model";         // POST { model_id, model_name }
    const USE_MODEL_POST_BASE     = "/dashboard";            // POST to /dashboard/<model_name>

    // ---------- Helpers ----------
    function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, m => (
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    ));
    }
    function fmtDate(iso) {
    try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
    }

    // ---------- Fetch + render ----------
    async function loadTrainedModels() {
    const grid = document.getElementById("trainedModelsGrid");
    if (!grid) return;

    grid.innerHTML = `
        <div class="col-12 text-center text-muted py-3"><em>Loading trained models…</em></div>
    `;

    try {
        const res = await fetch(TRAINED_MODELS_ENDPOINT, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const models = await res.json(); // expect array of objects

        renderTrainedModels(Array.isArray(models) ? models : []);
    } catch (err) {
        console.error("Failed to load trained models:", err);
        grid.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger mb-0">Failed to load trained models.</div>
        </div>
        `;
    }
    }

    function renderTrainedModels(models) {
    const grid = document.getElementById("trainedModelsGrid");
    if (!grid) return;

    if (!models.length) {
        grid.innerHTML = `
        <div class="col-12">
            <div class="alert alert-warning text-center mt-3 mb-0">No trained models found.</div>
        </div>
        `;
        return;
    }

    // Normalize property names in case your API uses slightly different keys
    const cards = models.map(m => {
        const model_id    = m.model_id    ?? m.id    ?? "";
        const model_name  = m.model_name  ?? m.name  ?? "";
        const model_type  = m.model_type  ?? m.type  ?? "";
        const corpus_names= m.corpus_names ?? m.corpora ?? "";
        const num_topics  = m.num_topics  ?? m.topics ?? "";
        const trained_on  = m.trained_on  ?? m.created_at ?? "";

        const safeName = escapeHtml(model_name);
        const safeType = escapeHtml(model_type);
        const safeCorp = escapeHtml(corpus_names);
        const safeTime = escapeHtml(fmtDate(trained_on));

        return `
        <div class="col d-flex">
            <div class="card shadow-sm position-relative w-100 h-100" style="border: 1px solid #e2e6ea;">
            <!-- Delete Icon -->
            <a href="#"
                class="position-absolute top-0 end-0 m-2 text-danger trained-model-delete"
                title="Delete model"
                data-id="${escapeHtml(model_id)}"
                data-name="${safeName}">
                <i class="bi bi-x-circle-fill fs-5"></i>
            </a>

            <div class="card-body d-flex flex-column justify-content-between">
                <div>
                <h6 class="card-title text-uppercase text-center text-primary fw-bold mb-2">${safeName}</h6>

                <p class="model-meta mb-1">
                    <strong class="text-muted">Type:</strong>
                    <span class="badge bg-info text-dark">${safeType}</span>
                </p>
                <p class="model-meta mb-1">
                    <strong class="text-muted">Corpus:</strong> ${safeCorp}
                </p>
                <p class="model-meta mb-1">
                    <strong class="text-muted">Topics:</strong> ${escapeHtml(String(num_topics))}
                </p>
                <p class="model-meta mb-0">
                    <strong class="text-muted">Created:</strong> ${safeTime}
                </p>
                </div>

                <div class="mt-3 text-end">
                <button class="btn btn-sm btn-primary use-model-btn"
                        data-model-id="${escapeHtml(model_id)}"
                        data-model-name="${safeName}">
                    Use Model
                </button>
                </div>
            </div>
            </div>
        </div>`;
    });

    grid.innerHTML = cards.join("");

    // Wire delete buttons
    grid.querySelectorAll(".trained-model-delete").forEach(a => {
        a.addEventListener("click", async (e) => {
        e.preventDefault();
        const id = a.getAttribute("data-id");
        const name = a.getAttribute("data-name");
        await deleteModel(id, name);
        });
    });

    // Wire "Use Model" buttons
    grid.querySelectorAll(".use-model-btn").forEach(btn => {
        btn.addEventListener("click", () => {
        const modelId = btn.getAttribute("data-model-id");
        const modelName = btn.getAttribute("data-model-name");

        // Create & submit a POST form to /dashboard/<model_name>
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `${USE_MODEL_POST_BASE}/${encodeURIComponent(modelName)}`;

        const inputId = document.createElement('input');
        inputId.type = 'hidden';
        inputId.name = 'model_id';
        inputId.value = modelId;
        form.appendChild(inputId);

        document.body.appendChild(form);
        form.submit();
        });
    });
    }

    // ---------- Delete model ----------
    async function deleteModel(modelId, modelName) {
    if (!modelId) return;
    if (!confirm(`Delete model "${modelName}"?`)) return;

    try {
        const res = await fetch(DELETE_MODEL_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model_id: modelId, model_name: modelName })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);

        alert(data?.message || "Model deleted.");
        loadTrainedModels(); // refresh list
    } catch (err) {
        console.error("Delete failed:", err);
        alert("Failed to delete model.");
    }
    }

    loadTrainedModels()



});
  </script>
</body>
</html>

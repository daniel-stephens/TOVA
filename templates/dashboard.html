<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TOVA Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>

body {
  display: flex;
  flex-direction: column;
}
.xsmall {
    font-size: 0.7rem !important;
  }
.compact-metric {
padding: 4px 6px !important;
margin-bottom: 4px !important;
border-radius: 4px;
}

.truncate-cell {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#docTableBody tr:hover {
  background-color: #f9f9f9;
  cursor: pointer;
}

.small-text {
  font-size: 0.85rem;
  line-height: 1.2;
}
.truncate-cell {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

main {
  flex-grow: 1;
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background-color: #f8f9fa;
  height: calc(100vh - 100px); /* Adjust based on your nav + footer */
  overflow-x: hidden; /* Prevent horizontal scroll */
  box-sizing: border-box;
}

.panel {
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 8px;
  border: 1px solid #ddd;
  padding: 1rem;
  width: 100%;
  height: auto;           
  box-sizing: border-box;
  overflow: visible;
}


.table-scroll-container {
  flex-grow: 1;
  overflow-y: auto;
  min-height: 0;
}

  .truncate-cell {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px; /* Adjust as needed */
    cursor: pointer;
  }

  #docDetailModal {
  z-index: 1065;
}
.modal-backdrop + .modal-backdrop {
  z-index: 1060;
}
#themeStatsTable th,
  #themeStatsTable td {
    padding: 0.3rem 0.5rem !important;
    font-size: 0.85rem;
  }

  #themeStatsTable tr {
    line-height: 1.1;
  }
  #themeStatsTable th,
  #themeStatsTable td {
    padding: 0.25rem 0.4rem !important;
    vertical-align: middle;
  }

  .table-scroll-wrapper {
    max-height: 100%;
  }

  .panel h6 {
    font-size: 0.8rem;
    margin-bottom: 0.3rem;
  }

  /* Make ID column narrower */
footer {
      background-color: #f1f3f5;
      text-align: center;
      padding: 0.75rem;
      font-size: 0.9rem;
      border-top: 1px solid #dee2e6;
    }
    
  /* Disable transition for our quick hideâ†’show bump */
  .modal.no-transition .modal-dialog {
    transition: none !important;
  }

  /* Rename Topic Button Styles */
  #renameThemeBtn {
    transition: opacity 0.2s ease, color 0.2s ease;
    color: #212529 !important;
    line-height: 1;
    opacity: 0.85;
  }

  #renameThemeBtn:hover {
    opacity: 1 !important;
    color: #0d6efd !important;
    transform: scale(1.1);
  }

  /* Show edit icon on hover of title */
  #selectedThemeLabel:hover #renameThemeBtn {
    opacity: 1;
    color: #212529 !important;
  }

  /* Theme Detail Modal Visual Enhancements */
  #themeDetailModal .modal-content {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: none;
  }

  #themeDetailModal .modal-header {
    background: linear-gradient(to right, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.95));
    border-bottom: 2px solid #e9ecef;
    padding: 1.25rem 1.5rem;
  }

  #themeDetailModal .modal-title {
    font-size: 1.5rem;
    letter-spacing: -0.02em;
  }

  #themeDetailModal #leftPanel {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: box-shadow 0.2s ease;
  }

  #themeDetailModal #leftPanel:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  /* Section Headers */
  #themeDetailModal .section-header {
    font-size: 0.875rem;
    font-weight: 600;
    color: #495057;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
  }

  /* Summary Section */
  #selectedThemeSummary {
    background: #f8f9fa;
    border-left: 3px solid;
    padding: 1rem;
    border-radius: 0.375rem;
    line-height: 1.6;
    font-size: 0.9rem;
  }

  /* Keywords Styling */
  #selectedThemeKeywords .badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.75rem;
    border-radius: 1rem;
    font-weight: 500;
    transition: all 0.2s ease;
    border: 1.5px solid;
  }

  #selectedThemeKeywords .badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
  }

  /* Diagnostics Cards */
  #themeDiagnosticsGrid .col > div {
    transition: all 0.2s ease;
    border: 1.5px solid #e9ecef;
  }

  #themeDiagnosticsGrid .col > div:hover {
    border-color: currentColor;
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  #themeDiagnosticsGrid .col strong {
    display: block;
    margin-bottom: 0.25rem;
    color: #495057;
    font-size: 0.8rem;
  }

  #themeDiagnosticsGrid .col .text-muted {
    font-size: 0.95rem;
    font-weight: 600;
  }

  /* Similarity Chart Container */
  #themeDetailModal .similarity-section {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
  }

  #themeDetailModal .similarity-section p {
    margin-bottom: 0.5rem;
  }

  /* Documents Section */
  #themeDetailModal .panel {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  /* Theme Detail Modal - Optimized Layout */
  #themeDetailModal .modal-dialog {
    max-width: 90vw;
    height: 90vh;
    margin: 5vh auto;
    display: flex;
    flex-direction: column;
  }

  #themeDetailModal .modal-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: 90vh;
  }

  /* Modal Header - Fixed */
  #themeDetailModal .modal-header {
    flex: 0 0 auto;
  }

  /* Modal Body - Flexible, scrollable */
  #themeDetailModal .modal-body {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Row container - fills available space */
  #themeDetailModal .modal-body > .row {
    flex: 1 1 auto;
    min-height: 0;
    display: flex;
    align-items: stretch;
  }

  /* Columns - equal height, flexible */
  #themeDetailModal .col-lg-6 {
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  /* Panels - fill column height */
  #themeDetailModal .panel {
    display: flex;
    flex-direction: column;
    min-height: 0;
    flex: 1 1 auto;
  }

  /* Left Panel - scrollable if content overflows */
  #themeDetailModal #leftPanel {
    overflow-y: auto;
    overflow-x: hidden;
  }

  /* Right Panel - documents section (already has flex from .panel rule above) */

  /* Table wrapper - fills remaining space, scrollable */
  #themeDetailModal #filteredTableWrapper {
    border-radius: 0.375rem;
    border: 1px solid #e9ecef;
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    overflow-x: auto;
    position: relative;
  }

  /* Modal Footer - Fixed at bottom */
  #themeDetailModal .modal-footer {
    flex: 0 0 auto;
    margin-top: auto;
  }

  #filteredTableBody tr {
    transition: all 0.15s ease;
  }

  #filteredTableBody tr:hover {
    background-color: #f8f9fa !important;
    transform: scale(1.01);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  #filteredTableHead {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #fff;
  }

  #filteredTableHead th {
    background-color: #f8f9fa;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    color: #6c757d;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 11;
  }

  /* Search Input */
  #filteredSearchInput {
    border-radius: 0.5rem;
    border: 1.5px solid #dee2e6;
    transition: all 0.2s ease;
  }

  #filteredSearchInput:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.1);
  }

  /* Rename Controls */
  #renameControls {
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
  }

  #renameThemeInput {
    border-radius: 0.375rem;
    border: 1.5px solid #dee2e6;
  }

  #renameThemeInput:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.1);
  }

  /* Modal Footer */
  #themeDetailModal .modal-footer {
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    padding: 1rem 1.5rem;
  }

  /* Responsive adjustments */
  @media (max-width: 991.98px) {
    #themeDetailModal .modal-dialog {
      max-width: 95vw;
      height: 95vh;
      margin: 2.5vh auto;
    }
    
    #themeDetailModal .modal-content {
      max-height: 95vh;
    }
    
    #themeDetailModal .row {
      flex-direction: column;
    }
    
    #themeDetailModal .col-lg-6 {
      min-height: 300px;
    }

    /* Chat sidebar responsive */
    #chatSidebar {
      width: 100%;
    }
    
    #chatWidgetBtn.sidebar-open {
      right: 20px !important;
    }
    
    #leftMainPanel,
    #documentsPanel {
      margin-right: 0 !important;
    }
  }

  /* Ensure table is always scrollable */
  @media (min-width: 992px) {
    #themeDetailModal #filteredTableWrapper {
      min-height: 400px;
    }
  }

  /* Loading state for charts */
  #similarityDotPlot {
    background: #f8f9fa;
    border-radius: 0.375rem;
  }

  /* Scrollbar styling */
  #filteredTableWrapper::-webkit-scrollbar {
    width: 8px;
  }

  #filteredTableWrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  #filteredTableWrapper::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }

  #filteredTableWrapper::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  /* Chat Sidebar Styles */
  #chatSidebar {
    position: fixed;
    top: 0;
    right: 0;
    width: 550px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 1040;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    overflow: hidden;
  }

  #chatSidebar.open {
    transform: translateX(0);
  }

  /* Main content adjustment handled via JavaScript */

  /* Chat Sidebar Backdrop - only show on mobile */
  #chatSidebarBackdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    z-index: 1039;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    display: none; /* Hidden on desktop */
  }

  #chatSidebarBackdrop.show {
    opacity: 1;
    visibility: visible;
  }

  @media (max-width: 991.98px) {
    #chatSidebarBackdrop {
      display: block; /* Show backdrop on mobile */
    }
    
    body:has(#chatSidebar.open) #mainContent {
      padding-right: 0; /* No padding adjustment on mobile */
    }
  }

  #chatSidebar .sidebar-header {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    color: white;
    padding: 0.875rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  #chatSidebar .sidebar-header h5 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }

  #chatSidebar .sidebar-header small {
    font-size: 0.8rem;
  }

  #chatSidebar .sidebar-header .btn-close {
    filter: invert(1);
    opacity: 0.8;
  }

  #chatSidebar .sidebar-header .btn-close:hover {
    opacity: 1;
  }

  #chatSidebar .sidebar-body {
    flex: 1 1 auto;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem;
    background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
    min-height: 0;
  }

  #chatSidebar .sidebar-footer {
    flex-shrink: 0;
    padding: 1rem;
    background: white;
    border-top: 1px solid #e9ecef;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
  }

  /* Chat Widget Button */
  #chatWidgetBtn {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    border: none !important;
    cursor: pointer !important;
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    z-index: 1039 !important;
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease !important;
  }

  #chatWidgetBtn:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2) !important;
    transform: scale(1.1) !important;
  }

  #chatWidgetBtn.sidebar-open {
    right: 570px !important;
  }

  #chatMessages {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f8f9fa;
  }

  #chatMessages::-webkit-scrollbar {
    width: 6px;
  }

  #chatMessages::-webkit-scrollbar-track {
    background: #f8f9fa;
  }

  #chatMessages::-webkit-scrollbar-thumb {
    background-color: #cbd5e0;
    border-radius: 3px;
  }

  #chatMessages::-webkit-scrollbar-thumb:hover {
    background-color: #a0aec0;
  }

  .chat-message {
    animation: fadeIn 0.3s ease-in;
    margin-bottom: 0.75rem;
  }

  .chat-message:last-child {
    margin-bottom: 0;
  }

  /* User message styling */
  .chat-message .user-message-bubble {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    color: white;
    border-radius: 16px 16px 4px 16px;
    padding: 0.6rem 0.9rem;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.4;
  }

  .chat-message .user-message-bubble p {
    margin: 0;
    font-size: 0.875rem;
  }

  .chat-message .user-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    flex-shrink: 0;
  }

  /* Assistant message styling */
  .chat-message .assistant-message-bubble {
    background: white;
    color: #212529;
    border-radius: 16px 16px 16px 4px;
    padding: 0.75rem 0.9rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.5;
    transition: box-shadow 0.2s ease;
  }

  .chat-message .assistant-message-bubble:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  }

  .chat-message .assistant-message-bubble .message-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.4rem;
    display: block;
  }

  .chat-message .assistant-message-bubble p {
    margin: 0;
    font-size: 0.875rem;
    color: #212529;
  }

  .chat-message .assistant-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(13, 110, 253, 0.25);
    flex-shrink: 0;
  }

  .chat-message .assistant-avatar svg {
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
  }

  /* Quick action buttons styling */
  .quick-action-btn {
    border-radius: 20px;
    padding: 0.35rem 0.7rem;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    border: 1.5px solid #dee2e6;
    background: white;
    color: #495057;
  }

  .quick-action-btn:hover {
    background: #f8f9fa;
    border-color: #0d6efd;
    color: #0d6efd;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(13, 110, 253, 0.15);
  }

  .quick-action-btn:active {
    transform: translateY(0);
  }

  /* Input styling */
  #chatInput {
    border-radius: 24px;
    border: 1.5px solid #dee2e6;
    padding: 0.65rem 1.1rem;
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }

  #chatInput:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    outline: none;
  }

  #chatSendBtn {
    border-radius: 50%;
    width: 38px;
    height: 38px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(13, 110, 253, 0.2);
  }

  #chatSendBtn svg {
    width: 16px;
    height: 16px;
  }

  #chatSendBtn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
  }

  #chatSendBtn:active {
    transform: scale(0.95);
  }

  /* Welcome message styling */
  .chat-message .welcome-message {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-left: 4px solid #0d6efd;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .chat-message .welcome-message .message-label {
    color: #0d6efd;
    font-weight: 600;
    font-size: 0.8rem;
    margin-bottom: 0.6rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chat-message .welcome-message ul {
    margin: 0.6rem 0 0 0;
    padding-left: 1.5rem;
    color: #6c757d;
    font-size: 0.85rem;
  }

  .chat-message .welcome-message ul li {
    margin-bottom: 0.4rem;
    line-height: 1.4;
  }

  .chat-message .welcome-message p {
    font-size: 0.875rem;
    margin-bottom: 0.6rem;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <!-- Brand -->
      <a class="navbar-brand fw-bold" href="/">TOVA</a>
  
      <!-- Mobile toggler -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
              aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <!-- Content -->
      <div class="collapse navbar-collapse" id="navbarContent">
        <!-- Primary flow (left) -->
        <ul class="navbar-nav me-auto align-items-lg-center gap-lg-2">
          <li class="nav-item">
            <a class="nav-link{% if request.path == '/' %} active{% endif %}"
               {% if request.path == '/' %}aria-current="page"{% endif %} href="/">
              Upload Data
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if 'load' in request.path %} active{% endif %}"
               {% if 'load' in request.path %}aria-current="page"{% endif %} href="/model">
              Initiate Training
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link{% if 'train' in request.path %} active{% endif %}"
               {% if 'train' in request.path %}aria-current="page"{% endif %} href="/trained-models">
              Manage Models
            </a>
          </li>
        </ul>
  
        <!-- Utilities / actions (right) -->
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <!-- Current model pill (optional; remove if not needed) -->
          <li class="nav-item d-none d-lg-block">
            <!-- <span class="badge text-bg-light border">
              Model: <span id="navCurrentModel">{{ model_id|e }}</span>
            </span> -->
            <!--<span class="badge text-bg-light border">
              Model: <span id="navCurrentModel">{{ model_name|e }}</span>
            </span>-->
          </li>
  
          <!-- Model Info (modal) -->
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               role="button"
               onclick="event.preventDefault(); showModelDetails('{{ model_id|e }}')">
              Model Info
            </a>
          </li>
  
          <!-- Save (modal) -->
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               role="button"
               onclick="event.preventDefault(); window.openSaveSettingsModal && window.openSaveSettingsModal();">
              Save
            </a>
          </li>
  
          <!-- Help dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="helpDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Help
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="helpDropdown">
              <li>
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#topicModelGuideModal">
                  Glossary
                </a>
              </li>
              <!-- Add more help links if needed -->
            </ul>
          </li>
  
          <!-- Primary action: Run Inference -->
          <li class="nav-item ms-lg-2">
            <button class="btn btn-primary"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#inferenceModal">
              Run Inference
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <div hidden id="model_id">{{model_id}}</div>
  
  <!-- Full Workspace -->
  <main class="flex-grow-1 px-4 py-3" id="mainContent" style="transition: padding-right 0.3s ease;">
    <div class="d-flex flex-grow-1 gap-3 h-100" style="position: relative; width: 100%;">
      
      <!-- LEFT PANEL -->
      <div class="d-flex flex-column gap-3" id="leftMainPanel" style="flex: 1 1 0; min-width: 0; height: 100%; min-height: 0;">
  
        <!-- Theme Overview Panel -->
        <div class="panel d-flex flex-column" style="flex: 1 1 0; min-height: 0;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">Theme Overview</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick="openVisibleThemeChart()">View Full Chart</button>

              <button id="toggleChartBtn" class="btn btn-sm btn-outline-primary">Switch to Grid View</button>
            </div>
          </div>
      
          <!-- Chart container -->
          <div class="flex-grow-1 d-flex position-relative" style="min-height: 0;">
            <canvas id="themeChart" class="w-100 h-100 position-absolute" hidden></canvas>
            <canvas id="themeChartGrid" class="w-100 h-100 position-absolute"></canvas>
          </div>
        </div>
      
        <!-- Diagnostics Panel (Initially Hidden) -->
        <div class="panel d-flex flex-column" style="flex: 1 1 0; min-height: 0;" hidden>
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h6 class="fw-bold text-dark mb-1" style="font-size: 0.9rem;">Theme Diagnostics</h6>
              <p class="text-muted mb-0" style="font-size: 0.75rem;">
                Summary of diagnostics for each theme.
              </p>
            </div>
          
            <button id="toggleMetricBtn" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-bar-chart-line me-1"></i> Switch to Model Metrics
            </button>
          </div>
          
      
          <!-- Theme Metrics Table -->
          <div id="themeMetricsPanel" class="flex-grow-1 d-flex flex-column" style="max-height: 90%;">
            <div class="table-scroll-wrapper flex-grow-1 border rounded overflow-auto">
              <table class="table table-sm table-hover align-middle mb-0" id="themeStatsTable" style="font-size: 0.75rem;">
                <thead class="table-light sticky-top" style="top: 0; z-index: 1;"></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
      
          <!-- Theme Insights Grid -->
          <div id="modelMetricsPanel" class="d-none flex-grow-1 d-flex flex-column">
            <h6 class="fw-bold mb-3 mt-2">Theme Insights</h6>
            <div id="themeInsightsGrid" class="row row-cols-2 small g-2 flex-grow-1 overflow-auto"></div>
          </div>
        </div>
      </div>
      
  
      <!-- RIGHT PANEL (Documents Table) -->
      <div class="panel d-flex flex-column flex-grow-1" id="documentsPanel" style="flex: 1 1 0; min-width: 0; overflow: hidden;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold mb-0">Documents</h6>
          <input type="text" id="docSearchInput" class="form-control form-control-sm w-50" placeholder="Search documents...">
        </div>
        <div class="d-flex flex-wrap align-items-end justify-content-between mb-3">
          <!-- Instruction (left) -->
          <div>
            <p class="text-muted small mb-1" style="font-size: 0.75rem;">
              Click on text to view full text information
            </p>
          </div>
        
          <!-- Filters (right) -->
          <div class="d-flex flex-wrap gap-2 align-items-end ms-auto">
            <!-- Theme Filter -->
            <div class="form-group">
              <label for="themeFilter" class="form-label mb-0 small">Theme</label>
              <select id="themeFilter" class="form-select form-select-sm">
                <option value="">All Themes</option>
              </select>
            </div>
        
            <!-- Min Score -->
            <div class="form-group">
              <label for="scoreMin" class="form-label mb-0 small">Min Score</label>
              <input type="number" id="scoreMin" class="form-control form-control-sm" style="width: 100px;" placeholder="0.00" step="0.001">
            </div>
        
            <!-- Max Score -->
            <div class="form-group">
              <label for="scoreMax" class="form-label mb-0 small">Max Score</label>
              <input type="number" id="scoreMax" class="form-control form-control-sm" style="width: 100px;" placeholder="1.00" step="0.001">
            </div>
        
            <!-- Apply Button -->
            <div class="form-group">
              <button id="filterBtn" class="btn btn-sm btn-primary">Apply Filters</button>
            </div>
          </div>
        </div>

        
        <div class="flex-grow-1 overflow-auto">
          <table class="table table-sm table-hover mb-0">
            <thead id="docTableHead" class="sticky-top bg-white"></thead>
            <tbody id="docTableBody"></tbody>
          </table>
        </div>
      </div>
  
    </div>
  </main>
  
  <footer>
    &copy; 2025 TOVA | AI-powered Topic Visualizer
  </footer>

  <!-- Chat Sidebar Backdrop -->
  <div id="chatSidebarBackdrop"></div>

  <!-- Chat Sidebar -->
  <div id="chatSidebar">
    <div class="sidebar-header">
      <div class="d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" class="me-2">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
          <circle cx="8" cy="10" r="1.5" fill="currentColor"/>
          <circle cx="12" cy="10" r="1.5" fill="currentColor"/>
          <circle cx="16" cy="10" r="1.5" fill="currentColor"/>
        </svg>
        <div>
          <h5 class="mb-0">Chat with Model</h5>
          <small class="opacity-75" id="chatModelName">Ask questions about topics and documents</small>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white" id="chatSidebarClose" aria-label="Close"></button>
    </div>
    <div class="sidebar-body">
      <div id="chatMessages">
        <div class="chat-message">
          <div class="d-flex align-items-start">
            <div class="flex-shrink-0 me-3">
              <div class="assistant-avatar">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="white" viewBox="0 0 24 24">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                  <circle cx="8" cy="10" r="1.5" fill="white"/>
                  <circle cx="12" cy="10" r="1.5" fill="white"/>
                  <circle cx="16" cy="10" r="1.5" fill="white"/>
                </svg>
              </div>
            </div>
            <div class="flex-grow-1">
              <div class="welcome-message">
                <span class="message-label">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="display: inline-block;">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                  </svg>
                  Model Assistant
                </span>
                <p style="margin-bottom: 0.6rem; color: #212529; font-weight: 500; font-size: 0.875rem;">Hello! I can help you explore your topic model. You can ask me:</p>
                <ul>
                  <li>Questions about specific topics or themes</li>
                  <li>To explain document classifications</li>
                  <li>About relationships between topics</li>
                  <li>To analyze document patterns</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="sidebar-footer">
      <!-- Quick Action Buttons -->
      <div class="d-flex flex-wrap gap-2 mb-3">
        <button class="btn btn-sm quick-action-btn" data-prompt="What are the main topics in this model?">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px; vertical-align: middle;">
            <path d="M1 2a1 1 0 0 1 1-1h11a1 1 0 0 1 1 1v.5a.5.5 0 0 0 .5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5a.5.5 0 0 0-.5.5v.5A1 1 0 0 1 13 14H2a1 1 0 0 1-1-1V2Zm13-1a2 2 0 0 1 2 2v.5a.5.5 0 0 1-.5.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .5.5a.5.5 0 0 1 .5.5v.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-.5a.5.5 0 0 1 .5-.5a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.5-.5A.5.5 0 0 1 0 4.5V2a2 2 0 0 1 2-2h12Z"/>
          </svg>
          Main Topics
        </button>
        <button class="btn btn-sm quick-action-btn" data-prompt="Explain the most common theme">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px; vertical-align: middle;">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </svg>
          Top Theme
        </button>
        <button class="btn btn-sm quick-action-btn" data-prompt="Show me documents related to">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px; vertical-align: middle;">
            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
          </svg>
          Find Documents
        </button>
      </div>
      <div class="input-group">
        <input type="text" 
               id="chatInput" 
               class="form-control" 
               placeholder="Ask about topics, documents, or themes..." 
               autocomplete="off">
        <button class="btn btn-primary" type="button" id="chatSendBtn" title="Send message">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-7.617L4.69 12.48l-1.655-2.597 9.782-1.91Z"/>
          </svg>
        </button>
      </div>
      <div class="d-flex align-items-center justify-content-between mt-2">
        <small class="text-muted">
          <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">Model Chat</span>
        </small>
        <small class="text-muted" style="font-size: 0.75rem;">
          <span class="d-inline-flex align-items-center">
            <span class="badge bg-success bg-opacity-10 text-success me-1" style="width: 8px; height: 8px; border-radius: 50%; padding: 0;"></span>
            Active
          </span>
        </small>
      </div>
    </div>
  </div>

  <!-- Model Chat Widget Button (Fixed Position) -->
  <button id="chatWidgetBtn" 
          class="btn btn-primary rounded-circle shadow-lg" 
          style="position: fixed !important; bottom: 20px !important; right: 20px !important; width: 64px !important; height: 64px !important; z-index: 1039 !important; display: flex !important; align-items: center !important; justify-content: center !important; background-color: #0d6efd !important; border: none !important; padding: 0 !important;"
          title="Chat with Model - Ask questions about topics and documents">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" viewBox="0 0 24 24" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
      <circle cx="8" cy="10" r="1.5" fill="white"/>
      <circle cx="12" cy="10" r="1.5" fill="white"/>
      <circle cx="16" cy="10" r="1.5" fill="white"/>
      <path d="M12 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="white" opacity="0.8"/>
    </svg>
  </button>


  <!-- Modal -->
<div class="modal fade" id="modelInfoModal" tabindex="-1" aria-labelledby="modelInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modelInfoModalLabel">Model Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" id="modelDetailBody">
        <!-- JS will inject model details here -->
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  

  <div class="modal fade" id="inferenceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Run Inference</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  
        <div class="modal-body">
          <!-- Toggle Buttons -->
          <div class="mb-3 d-flex justify-content-end">
            <div class="btn-group" role="group" aria-label="Input Type">
              <button type="button" class="btn btn-outline-primary active" id="toggleTextInput">Text Input</button>
              <button type="button" class="btn btn-outline-primary" id="toggleFileInput">Upload File</button>
            </div>
          </div>
  
        <!-- Inference Results -->
        <div  class="mt-6">
            <!-- <h6 class="fw-bold mb-3">Inference Summary</h6> -->
            <div id="textInputGroup" class="row">
            <!-- Left Column: Input Text Display -->
            <div id="textAreaSpace" class="col-md-12">
                <strong>Enter or Paste Text:</strong>
                <div class="mb-3" id="textInputGroup">
                  <textarea 
                    id="inputText" 
                    class="form-control rounded-3 shadow-sm p-3" 
                    rows="15" 
                    placeholder="Start typing or paste your unstructured text here..."></textarea>
                </div>
              </div>
              
        
            <!-- Right Column: Theme, Rationale, Chart -->
            <div id="inferredResults" class="col-md-5" style="display: none;">
                <div class="mb-3 mt-1 d-flex align-items-center">
                <strong>Top Theme:</strong>
                <p id="inferredTheme" class="fw-semibold text-primary mb-0">-</p>
                </div>

                <div id="inferredKeywordsWrapper" class="mb-2">
                  <strong>Theme Keywords:</strong>
                  <p id="inferredKeywords" class="small text-muted mb-0" style="white-space: pre-wrap;"></p>
                </div>
                
        
                <div class="mb-3">
                  <div id="inferredRationaleWrapper">
                    <p><strong>Rationale:</strong> <span id="inferredRationale">-</span></p>
                  </div>                  
              </div>
        
                <div class="mt-4">
                <strong>Theme Probabilities:</strong>
                <div style="height: 250px;">
                    <canvas id="inferredThemeChart"></canvas>
                </div>
                </div>
            </div>
            </div>
        </div>
  
          <!-- File Input Section -->
          <div id="fileInputGroup" style="display: none;">
            <div class="mb-3">
              <label for="textFile" class="form-label">Upload File</label>
              <input class="form-control" type="file" id="files" accept=".csv,.json,.jsonl,.xls,.xlsx,.txt" />
            </div>
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Text Column</label>
                <select id="textColumn" class="form-select mt-1">
                  <option disabled selected>Select text column...</option>
                </select>
              </div>
                    <div class="col-md-6">
                        <label class="form-label">ID Column</label>
                        <select id="idColumn" class="form-select mt-1">
                        <option disabled selected>Select id column...</option>
                        </select>
                    </div>
                    </div>
                </div>
                <div class="mt-2 small text-muted" id="inferStatus"></div>
                <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" id="inferBtn">Infer</button>
                </div>
            </div>
            </div>
        </div>
  </div>

  <div class="modal fade" id="docDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Document Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
            <!-- <h6 class="fw-bold mb-3">Inference Summary</h6> -->
            <div class="row">
              <!-- Left Column: Full Text -->
              <div class="col-md-6">
                <strong>Full Text:</strong>
                <div class="border rounded p-2 bg-light-subtle" style="max-height: 500px; overflow-y: auto;">
                  <p id="modalFullText" class="mb-0 small" style="white-space: pre-wrap;"></p>
                </div>
              </div>
          
              <!-- Right Column: Theme, Rationale, Chart -->
              <div  class="col-md-6">
                <!-- Top Theme -->
                <div class="mb-3 mt-1 d-flex align-items-center">
                  <strong>Top Theme:</strong>
                  <!-- <p id="modalTheme" class="fw-semibold text-primary mb-0">-</p> -->
                  <p id="modalTheme" class="fw-semibold mb-0">-</p>

                </div>

                <div>
                  <strong>Theme Keywords:</strong>
                  <pre id="modalKeywords" class="small-text mb-0"></pre>
                </div>
                

                <!-- Rationale -->
                <div id="rationalDiv" class="mb-3">
                  <strong>Rationale:</strong>
                  <p id="modalRationale" class="fst-italic small text-muted mb-0" style="white-space: pre-wrap;"></p>
                </div>
        
                <hr>
                <!-- Chart -->
                <div class="mt-4">
                  <strong>Theme Probabilities:</strong>
                  <div style="height: 250px;">
                    <canvas id="docInferenceChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

<div class="modal-content" id="themeModalContent">
  <div class="modal fade" id="themeDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <div class="d-flex align-items-center flex-grow-1">
            <h5 class="modal-title fw-bold mb-0 d-flex align-items-center" id="selectedThemeLabel">
              <span id="themeTitleText">Theme Details</span>
              <button type="button" 
                      class="btn btn-link p-0 ms-2" 
                      id="renameThemeBtn" 
                      title="Rename this topic"
                      style="display: inline-flex; align-items: center; text-decoration: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .146-.354l6-6z"/>
                </svg>
              </button>
            </h5>
            <div id="renameControls" style="display: none; align-items: center; gap: 0.5rem;">
              <input type="text" 
                     class="form-control form-control-sm" 
                     id="renameThemeInput" 
                     style="max-width: 250px;"
                     placeholder="Enter new topic name...">
              <button type="button" 
                      class="btn btn-sm btn-success" 
                      id="saveRenameBtn">
                Save
              </button>
              <button type="button" 
                      class="btn btn-sm btn-secondary" 
                      id="cancelRenameBtn">
                Cancel
              </button>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
          <div class="row g-3 align-items-stretch">
            
            <!-- Left Column: Summary + Diagnostics + Similarity -->
            <div class="col-lg-6 d-flex">
              <div id="leftPanel" class="panel d-flex flex-column p-4 bg-white border rounded w-100">
                <!-- Summary Section -->
                <div class="mb-4">
                  <div class="section-header">Summary</div>
                  <p id="selectedThemeSummary" class="small text-muted fst-italic mb-0">-</p>
                </div>
        
                <!-- Keywords Section -->
                <div class="mb-4">
                  <div class="section-header">Top Keywords</div>
                  <div id="selectedThemeKeywords" class="d-flex flex-wrap gap-2 small"></div>
                </div>
        
                <!-- Diagnostics Section -->
                <div class="mb-4">
                  <div class="section-header">Theme Diagnostics</div>
                  <div id="themeDiagnosticsGrid" class="row row-cols-2 g-3">
                    <!-- JS will inject diagnostics here -->
                  </div>
                </div>
        
                <!-- Similarity Section -->
                <div class="similarity-section">
                  <div class="section-header">Similar Themes</div>
                  <canvas id="similarityDotPlot" height="150"></canvas>
                  <p class="small text-muted mt-3 mb-0" style="font-size: 0.75rem; line-height: 1.5;">
                    <strong>Note:</strong> Higher similarity scores (closer to +1) indicate stronger co-occurrence and greater similarity between topics. Values near 0 suggest little or no relationship, while negative values indicate that the topics rarely appear together (less similar).
                  </p>
                </div>
              </div>
            </div>
        
            <!-- Right Column: Document Table -->
            <div class="col-lg-6 d-flex">
              <div class="panel d-flex flex-column p-4 bg-white border rounded w-100">
                <div class="mb-3 flex-shrink-0">
                  <div class="section-header">Documents</div>
                  <p class="small text-muted mb-3" style="font-size: 0.8rem;">Click on any row to view full document details</p>
                  <input type="text" id="filteredSearchInput" class="form-control form-control-sm mb-0" placeholder="ðŸ” Search documents..." />
                </div>
        
                <!-- Table wrapper - flexible height, scrollable -->
                <div id="filteredTableWrapper" class="flex-grow-1" style="min-height: 200px;">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead id="filteredTableHead"></thead>
                    <tbody id="filteredTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
            
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="topicModelGuideModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title fw-bold">Topic Modeling Glossary</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body small">
          <p class="text-muted fst-italic">
            This glossary explains the terms used in the Topic Modeling Dashboard to help you understand how themes are generated and evaluated.
          </p>
  
          <dl class="row">
            <dt class="col-sm-4 fw-semibold">Topic / Theme</dt>
            <dd class="col-sm-8">A group of keywords that frequently co-occur across documents, forming a coherent semantic idea.</dd>
  
            <dt class="col-sm-4 fw-semibold">Top Keywords</dt>
            <dd class="col-sm-8">The most representative words of a theme, used to describe its content.</dd>
  
            <dt class="col-sm-4 fw-semibold">Prevalence</dt>
            <dd class="col-sm-8">The percentage of documents that are primarily associated with a particular theme.</dd>
  
            <dt class="col-sm-4 fw-semibold">Coherence</dt>
            <dd class="col-sm-8">A measure of how semantically consistent the top keywords of a theme are. Higher is better.</dd>
  
            <dt class="col-sm-4 fw-semibold">Keyword Uniqueness</dt>
            <dd class="col-sm-8">Indicates how exclusive a theme's keywords are compared to those in other themes.</dd>
  
            <dt class="col-sm-4 fw-semibold">Theme Summary</dt>
            <dd class="col-sm-8">A brief, human-readable description of what the theme represents.</dd>
  
            <dt class="col-sm-4 fw-semibold">Theme Diagnostics</dt>
            <dd class="col-sm-8">Includes metrics like coherence, prevalence, and purity used to assess the quality of the theme.</dd>
  
            <dt class="col-sm-4 fw-semibold">Purity Score</dt>
            <dd class="col-sm-8">Represents how cleanly documents within a theme belong to it, without overlapping heavily with others.</dd>
  
            <dt class="col-sm-4 fw-semibold">Entropy (Balance)</dt>
            <dd class="col-sm-8">Shows how evenly documents are distributed across all topics. High entropy means better balance.</dd>
  
            <dt class="col-sm-4 fw-semibold">Document Match</dt>
            <dd class="col-sm-8">The number of documents whose content is most aligned with a particular theme.</dd>
  
            <dt class="col-sm-4 fw-semibold">Trend Over Time</dt>
            <dd class="col-sm-8">A line graph showing how often a theme appears across time (e.g. monthly or yearly).</dd>
  
            <dt class="col-sm-4 fw-semibold">Top Representative Document</dt>
            <dd class="col-sm-8">A document that best reflects the core idea of a theme based on keyword and score alignment.</dd>
  
            <dt class="col-sm-4 fw-semibold">Similarity</dt>
            <dd class="col-sm-8">Indicates how similar one theme is to others based on shared keywords or document distribution.</dd>
          </dl>
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close Glossary</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="fullChartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Full Chart View</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <canvas id="fullChartCanvas" width="1000" height="600"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <pre id="output" style="white-space:pre-wrap; font-family:monospace;"></pre>

  
  

  
  
  

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const modelId   = document.getElementById("model_id")?.textContent?.trim() || ""; 

  // ---------------------------
  // Stacked modal helper (bring-to-front)
  // ---------------------------
  (function injectNoTransitionStyle() {
    if (document.getElementById("noTransitionStyle")) return;
    const style = document.createElement("style");
    style.id = "noTransitionStyle";
    style.textContent = ".modal.no-transition .modal-dialog{transition:none!important}";
    document.head.appendChild(style);
  })();

  function bringModalToFront(modalEl) {
    if (!modalEl) return;
    const instance = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: true, focus: true });

    // If closed, normal show.
    if (!modalEl.classList.contains("show")) {
      instance.show();
      return;
    }

    // Already open â†’ bump to top (hide -> show, no animation).
    modalEl.classList.add("no-transition");
    instance.hide();

    queueMicrotask(() => {
      // Keep body locked if any other modal is open.
      if (document.querySelectorAll(".modal.show").length > 0) {
        document.body.classList.add("modal-open");
      }
      instance.show();
      requestAnimationFrame(() => modalEl.classList.remove("no-transition"));
    });
  }

  // ---------------------------
  // Global state
  // ---------------------------
  let dashboardV2 = null;        // normalized single-fetch bundle
  let themeChartInstance = null;
  let scatterChartInstance = null;
  const inferenceCharts = {};    // keyed by canvas id
  let themeColorMap = {};        // { [themeId]: color }
  let docsArray = [];
  let textInferenceChart = null;            // cached rows for main table

  // ---------------------------
  // Helpers
  // ---------------------------
  function computeColor(index, cfg = {}) {
    const golden = 137.508;
    const hue = (index * golden + (cfg.seed || 0)) % 360;
    const sat = Array.isArray(cfg.saturation) ? cfg.saturation[index % cfg.saturation.length] : 75;
    const lig = Array.isArray(cfg.lightness) ? cfg.lightness[index % cfg.lightness.length] : 60;
    return `hsl(${hue}, ${sat}%, ${lig}%)`;
  }

  function lightBgFromColor(color) {
    if (!color) return "rgba(0,0,0,0.04)";
    if (color.startsWith("hsl(")) return color.replace("hsl(", "hsla(").replace(")", ", 0.12)");
    if (color.startsWith("rgb(")) return color.replace("rgb(", "rgba(").replace(")", ", 0.12)");
    return "rgba(0,0,0,0.04)";
  }

  // ---------------------------
  // Accessors for normalized bundle
  // ---------------------------
  const themeIds       = () => dashboardV2.themes.allIds;
  const themeById      = (id) => dashboardV2.themes.byId[String(id)];
  const coordByThemeId = (id) => dashboardV2.coordinates?.byThemeId?.[String(id)];
  const diagByThemeId  = (id) => dashboardV2.diagnostics?.byThemeId?.[String(id)];

  function themesForChart() {
    const ids = themeIds();
    return ids.map((id, i) => {
      const t = themeById(id);
      const color = computeColor(i, dashboardV2.color);
      return {
        id: t.id,
        label: getThemeLabel(id),
        document_count: t.documentCount,
        color,
        keywords: (t.keywords || []).join(", ")
      };
    });
  }

  function docsForTable() {
    const out = [];
    for (const id of dashboardV2.documents.allIds) {
      const d = dashboardV2.documents.byId[id];
      const t = themeById(d.themeId);
      const r = (typeof d.rationale === "string" && d.rationale.trim()) ? d.rationale.trim() : undefined;
      const row = {
        id: d.id,
        text: d.text,
        theme: t ? getThemeLabel(t.id) : "â€”",
        theme_id: t?.id ?? null,
        score: d.score
      };
      if (r) row.rationale = r;
      out.push(row);
    }
    return out;
  }

  function diagnosticsForTable() {
    return themeIds().map(id => {
      const t = themeById(id);
      const d = diagByThemeId(id) || {};
      return { theme: getThemeLabel(id), ...d };
    });
  }

  function coordinatesForScatter() {
    return themeIds().map((id) => {
      const t = themeById(id);
      const c = coordByThemeId(id) || { x: 0, y: 0, size: t.documentCount || 1 };
      return { id: Number(id), label: getThemeLabel(id), x: c.x, y: c.y, size: c.size, keywords: t.keywords || [] };
    });
  }

  function similaritiesForTheme(themeId) {
    const raw = dashboardV2.similarities?.[String(themeId)] || [];
    return raw.map(([ID, Similarity]) => ({ ID, Similarity }));
  }

  // ---------------------------
  // Charts
  // ---------------------------
  function createThemeChartData(themes) {
    return {
      labels: themes.map(t => t.label),
      ids: themes.map(t => t.id),
      meta: themes.map(t => ({ id: t.id, color: t.color, keywords: t.keywords })),
      datasets: [{
        data: themes.map(t => t.document_count),
        backgroundColor: themes.map(t => t.color || "#0d6efd")
      }]
    };
  }

  function renderThemeChart(chartData) {
    themeColorMap = {};
    chartData.meta.forEach(m => { themeColorMap[m.id] = m.color || "#0d6efd"; });

    const canvas = document.getElementById("themeChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (themeChartInstance) themeChartInstance.destroy();

    themeChartInstance = new Chart(ctx, {
      type: "bar",
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const i = ctx.dataIndex;
                const count = ctx.parsed.y;
                const meta = chartData.meta?.[i];
                const raw = meta?.keywords || "â€”";
                if (typeof raw !== "string") return [`${count} documents`, "Keywords: â€”"];
                const words = raw.split(", ").map(w => w.trim());
                const lines = [];
                for (let j = 0; j < words.length; j += 5) lines.push(words.slice(j, j + 5).join(", "));
                return [`${count} documents`, "Keywords:"].concat(lines);
              }
            }
          }
        },
        scales: {
          x: { ticks: { maxRotation: 45, minRotation: 30 } },
          y: { beginAtZero: true, title: { display: true, text: "Documents" } }
        },
        onClick: (e, els) => {
          if (!els.length) return;
          const idx = els[0].index;
          const meta = chartData.meta?.[idx];
          if (!meta) return;
          openThemeModal(meta.id, meta.color || "#0d6efd");
        }
      }
    });
  }

  function renderDocInformationChart(topThemes = [], targetCanvasId = "docInferenceChart") {
    const canvas = document.getElementById(targetCanvasId);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (inferenceCharts[targetCanvasId]) inferenceCharts[targetCanvasId].destroy();

    const getColor = id => themeColorMap[Number(id)] || "#0d6efd";
    const backgroundColors = topThemes.map(t => getColor(t.theme_id));

    inferenceCharts[targetCanvasId] = new Chart(ctx, {
      type: "bar",
      data: {
        labels: topThemes.map(t => t.label),
        datasets: [{ data: topThemes.map(t => t.score), backgroundColor: backgroundColors }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, max: 1 } },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const t = topThemes[ctx.dataIndex];
                const pct = (ctx.parsed.y * 100).toFixed(1);
                const kws = (t.keywords || "No keywords").split(", ").map(k => k.trim());
                const lines = [];
                for (let i = 0; i < kws.length; i += 5) lines.push(kws.slice(i, i + 5).join(", "));
                return [`Score: ${pct}%`, "Keywords:"].concat(lines);
              }
            }
          }
        },
        
      }
    });
  }

  function plotScatterChart(pointsIn) {
    const canvas = document.getElementById("themeChartGrid");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (scatterChartInstance) scatterChartInstance.destroy();

    const minSize = Math.min(...pointsIn.map(d => d.size));
    const maxSize = Math.max(...pointsIn.map(d => d.size));
    const normalize = s => {
      const minR = 10, maxR = 40;
      if (maxSize === minSize) return (minR + maxR) / 2;
      return ((s - minSize) / (maxSize - minSize)) * (maxR - minR) + minR;
    };

    const points = pointsIn.map(d => {
      const solid = themeColorMap[d.id] || "rgb(66,133,244)";
      const fill = solid.startsWith("hsl(")
        ? solid.replace("hsl(", "hsla(").replace(")", ", 0.2)")
        : solid.replace("rgb(", "rgba(").replace(")", ", 0.2)");
      return {
        x: d.x, y: d.y, r: normalize(d.size),
        label: d.label, id: d.id, keywords: d.keywords || [],
        color: solid, backgroundColor: fill, borderColor: solid
      };
    });

    const labelPlugin = {
      id: "themeLabels",
      afterDatasetsDraw(chart) {
        const { ctx } = chart;
        ctx.save();
        const meta = chart.getDatasetMeta(0);
        meta.data.forEach((pt, i) => {
          const { x, y } = pt.getCenterPoint();
          ctx.fillStyle = "#000";
          ctx.font = "bold 13px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(points[i].label, x, y);
        });
        ctx.restore();
      }
    };

    scatterChartInstance = new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [{
          label: "Themes",
          data: points,
          backgroundColor: points.map(p => p.backgroundColor),
          borderColor: points.map(p => p.borderColor),
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 20 },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const p = points[ctx.dataIndex];
                const kws = Array.isArray(p.keywords) ? p.keywords : [];
                const lines = [];
                for (let i = 0; i < kws.length; i += 5) lines.push(kws.slice(i, i + 5).join(", "));
                return [p.label, "Keywords:"].concat(lines);
              }
            }
          }
        },
        elements: {
          point: {
            radius: ctx => points[ctx.dataIndex].r || 20,
            hoverRadius: ctx => (points[ctx.dataIndex].r || 20) * 1.2
          }
        },
        onClick: (e, els) => {
          if (!els.length) return;
          const idx = els[0].index;
          const p = points[idx];
          openThemeModal(p.id, p.color || "#0d6efd");
        },
        scales: {
          x: { ticks: { display: false }, grid: { color: "rgba(0,0,0,0.1)" } },
          y: { ticks: { display: false }, grid: { color: "rgba(0,0,0,0.1)" } }
        }
      },
      plugins: [labelPlugin]
    });
  }

  function renderThemeSimilarityChart(similarThemesObjs) {
    const canvas = document.getElementById("similarityDotPlot");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    const processed = (similarThemesObjs || [])
      .map(t => ({ id: t.ID, theme: themeById(t.ID)?.label || `Theme ${t.ID}`, similarity: parseFloat(t.Similarity) }))
      .sort((a, b) => Math.abs(b.similarity) - Math.abs(a.similarity));

    const labels = processed.map(t => t.theme);
    const values = processed.map(t => t.similarity);
    const colors = processed.map(t => themeColorMap[t.id] || "#4B8DF8");

    if (window.similarityDotPlot instanceof Chart) window.similarityDotPlot.destroy();

    window.similarityDotPlot = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label: "Similarity Score", data: values, backgroundColor: colors, borderRadius: 4 }] },
      options: {
        indexAxis: "y",
        responsive: true,
        scales: { x: { min: -1, max: 1, ticks: { stepSize: 0.2 }, title: { display: true, text: "Similarity Score - Correlation Between Themes" } } },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `Similarity: ${ctx.raw.toFixed(3)}` } }
        },
        // onClick: (e, els) => {
        //   if (!els.length) return;
        //   const idx = els[0].index;
        //   const t = processed[idx];
        //   openThemeModal(t.id, themeColorMap[t.id] || "#0d6efd");
        // }
      }
    });
  }

  // ---------------------------
  // Tables & Filters
  // ---------------------------
  // If the backend sends the metric order, we'll use it
  function getMetricOrder() {
    return Array.isArray(dashboardV2?.metric_order) ? dashboardV2.metric_order.slice() : null;
  }
  function getMetricLabels() {
    return (dashboardV2?.metric_labels && typeof dashboardV2.metric_labels === "object")
      ? dashboardV2.metric_labels
      : {};
  }

  // Human label: prefer backend labels; otherwise Title Case from key
  function prettyLabel(key) {
    const L = getMetricLabels();
    if (L[key]) return String(L[key]);
    return String(key)
      .replace(/([a-z0-9])([A-Z])/g, "$1 $2") // split camelCase
      .replace(/[_\-]+/g, " ")                // split snake/kebab
      .trim()
      .split(/\s+/)
      .map(w => w ? w[0].toUpperCase() + w.slice(1).toLowerCase() : w)
      .join(" ");
  }

  // format numbers
  function fmtValue(_key, value) {
    if (value == null || (typeof value === "number" && Number.isNaN(value))) return "â€”";
    if (typeof value === "number") {
      return Number.isInteger(value) ? value.toLocaleString() : value.toFixed(3);
    }
    return String(value);
  }

  // Build the active diagnostics key list:
  // If backend provides metric_order, use it (but only keys that actually appear with a value).
  // Otherwise, preserve first-seen order across diagnostics objects sent by the backend.
  function getActiveDiagnosticKeys() {
    const presence = new Map();
    const seenOrder = [];

    for (const id of themeIds()) {
      const d = diagByThemeId(id) || {};
      for (const k of Object.keys(d)) {
        if (!presence.has(k)) { presence.set(k, false); seenOrder.push(k); }
        const v = d[k];
        const ok = v != null && !(typeof v === "number" && Number.isNaN(v));
        if (ok) presence.set(k, true);
      }
    }

    const observed = seenOrder.filter(k => presence.get(k));
    const backendOrder = getMetricOrder();

    if (backendOrder) {
      const ordered = backendOrder.filter(k => observed.includes(k));
      const leftovers = observed.filter(k => !backendOrder.includes(k));
      return [...ordered, ...leftovers];
    }
    return observed;
  }

  function ensureDocDiagnosticsBlock() {
    // Right column of the Document Details modal
    const rightCol = document.querySelector("#docDetailModal .modal-body .col-md-6:nth-child(2)");
    if (!rightCol) return null;

    let holder = document.getElementById("docDiagnosticsHolder");
    if (!holder) {
      holder = document.createElement("div");
      holder.id = "docDiagnosticsHolder";
      holder.className = "mt-3";
      holder.innerHTML = `
        <div class="mb-2"><strong>Theme Diagnostics (for this document's theme)</strong></div>
        <div id="docDiagnosticsGrid" class="row row-cols-2 g-2"></div>
      `;
      // Insert before the probabilities chart block if present, otherwise at top
      const chartBlock = rightCol.querySelector(".mt-4");
      rightCol.insertBefore(holder, chartBlock || rightCol.firstChild);
    }
    return document.getElementById("docDiagnosticsGrid");
  }

  function renderDocumentTable(docs = []) {
    const thead = document.getElementById("docTableHead");
    const tbody = document.getElementById("docTableBody");
    if (!thead || !tbody) return;
    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (docs.length === 0) {
      thead.innerHTML = `<tr><th>No data</th></tr>`;
      tbody.innerHTML = `<tr><td class="text-muted">No documents to display.</td></tr>`;
      return;
    }

    const hasRationale = docs.some(doc => "rationale" in doc);
    const columns = hasRationale ? ["id", "text", "theme", "rationale", "score"] : ["id", "text", "theme", "score"];

    const columnWidths = hasRationale ? {
      id: "12%", text: "38%", theme: "20%", rationale: "20%", score: "3%"
    } : {
      id: "10%", text: "70%", theme: "10%", score: "3%"
    };

    const headerRow = document.createElement("tr");
    columns.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col.charAt(0).toUpperCase() + col.slice(1).replace(/_/g, " ");
      th.classList.add("small-text", "align-middle", "text-nowrap");
      th.style.width = columnWidths[col] || "auto";
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    docs.forEach(doc => {
      const row = document.createElement("tr");
      const searchBlob = [doc.id, doc.text, doc.theme, doc.rationale ?? "", String(doc.score ?? "")]
        .join(" ").toLowerCase();
      row.dataset.search = searchBlob;
      row.classList.add("small-text");
      row.addEventListener("click", () => showDocumentInfoModal(doc));

      columns.forEach(col => {
        const td = document.createElement("td");
        let value = doc[col];

        if (col === "score" && typeof value === "number") {
          td.textContent = value.toFixed(3);
          td.title = td.textContent;
        } else {
          td.textContent = value !== undefined && value !== null ? String(value) : "â€”";
          td.title = td.textContent;
        }

        // Color the theme name to match the charts
        if (col === "theme") {
          const color = themeColorMap[Number(doc.theme_id)] || null;
          if (color) {
            td.style.color = color;
            td.style.fontWeight = "600";
          }
        }

        td.classList.add("truncate-cell", "small-text");
        td.style.width = columnWidths[col] || "auto";
        row.appendChild(td);
      });
      tbody.appendChild(row);
    });
  }

  function populateThemeFilter(docs) {
    const themeFilter = document.getElementById("themeFilter");
    if (!themeFilter) return;
    themeFilter.innerHTML = `<option value="">All</option>`;
    const set = [...new Set(docs.map(d => d.theme).filter(Boolean))];
    set.forEach(theme => {
      const opt = document.createElement("option");
      opt.value = theme;
      opt.textContent = theme;
      themeFilter.appendChild(opt);
    });
  }

  function applyFilters() {
    const theme = document.getElementById("themeFilter")?.value || "";
    const minScore = parseFloat(document.getElementById("scoreMin")?.value || "");
    const maxScore = parseFloat(document.getElementById("scoreMax")?.value || "");

    const filtered = docsArray.filter(doc => {
      const matchTheme = !theme || doc.theme === theme;
      const matchMin = isNaN(minScore) || doc.score >= minScore;
      const matchMax = isNaN(maxScore) || doc.score <= maxScore;
      return matchTheme && matchMin && matchMax;
    });

    renderDocumentTable(filtered);
    const input = document.getElementById("docSearchInput");
    if (input) input.dispatchEvent(new Event("input"));
  }

  document.getElementById("docSearchInput")?.addEventListener("input", ((fn, ms = 150) => {
    let t;
    return function() {
      clearTimeout(t);
      const self = this, args = arguments;
      t = setTimeout(() => fn.apply(self, args), ms);
    };
  })(function () {
    const query = this.value.toLowerCase().trim();
    const rows = document.querySelectorAll("#docTableBody tr");
    rows.forEach(row => {
      const content = row.dataset.search || "";
      row.style.display = content.includes(query) ? "" : "none";
    });
  }, 100));

  document.getElementById("filteredSearchInput")?.addEventListener("input", ((fn, ms = 150) => {
    let t;
    return function() {
      clearTimeout(t);
      const self = this, args = arguments;
      t = setTimeout(() => fn.apply(self, args), ms);
    };
  })((e) => {
    const term = e.target.value.toLowerCase();
    const rows = document.querySelectorAll("#filteredTableBody tr");
    rows.forEach(row => {
      const content = row.dataset.search || "";
      row.style.display = content.includes(term) ? "" : "none";
    });
  }, 100));

  document.getElementById("filterBtn")?.addEventListener("click", applyFilters);

  function populateThemeDiagnosticsTable(rows = []) {
    const tableHead = document.querySelector("#themeStatsTable thead");
    const tableBody = document.querySelector("#themeStatsTable tbody");
    if (!tableHead || !tableBody) return;

    tableHead.innerHTML = "";
    tableBody.innerHTML = "";

    if (!rows.length) {
      tableHead.innerHTML = `<tr><th>No Data</th></tr>`;
      tableBody.innerHTML = `<tr><td class="text-muted">No diagnostics available.</td></tr>`;
      return;
    }

    const diagKeys = getActiveDiagnosticKeys();
    const columns = ["theme", ...diagKeys];

    // Header
    const headerRow = document.createElement("tr");
    columns.forEach(col => {
      const th = document.createElement("th");
      th.textContent = prettyLabel(col);
      th.style.position = "sticky"; th.style.top = "0"; th.style.backgroundColor = "#fff"; th.style.zIndex = "1";
      headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    // Body
    rows.forEach(r => {
      const tr = document.createElement("tr");
      columns.forEach(col => {
        const td = document.createElement("td");
        td.textContent = (col === "theme") ? (r[col] ?? "â€”") : fmtValue(col, r[col]);
        td.title = td.textContent;
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });
  }

  function renderThemeMetrics(metrics = []) {
    const container = document.getElementById("themeInsightsGrid");
    if (!container) return;
    container.innerHTML = "";
    metrics.forEach(metric => {
      const col = document.createElement("div");
      col.className = "col-md-6";
      col.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-3 rounded bg-light shadow-sm">
          <div class="text-muted small fw-semibold">${metric.label}</div>
          <div class="fw-bold text-dark small">${
            typeof metric.value === "number"
              ? (metric.label.toLowerCase().includes("prevalence") ? (metric.value * 100).toFixed(1) + "%" : metric.value.toFixed(2))
              : metric.value
          }</div>
        </div>
      `;
      container.appendChild(col);
    });
  }

  // ---------------------------
  // Theme Rename Functionality
  // ---------------------------
  let themeRenames = {}; // Store renamed themes in memory only: { themeId: newLabel }
  
  // Load saved renames from backend API (called on page load)
  async function loadThemeRenames() {
    const modelId = document.getElementById("model_id")?.textContent?.trim() || "";
    if (!modelId) {
      themeRenames = {};
      return;
    }
    
    try {
      const response = await fetch(`/api/models/${modelId}/topics/renames`);
      if (response.ok) {
        const data = await response.json();
        // Backend returns { topic_labels: { "1": "New Name", "2": "Another Name" } }
        themeRenames = data.topic_labels || {};
        console.log("Loaded topic renames from backend:", themeRenames);
      } else {
        // No renames found or error - use empty object
        themeRenames = {};
      }
    } catch (e) {
      console.error("Failed to load theme renames from backend:", e);
      themeRenames = {};
    }
  }
  
  // Get theme label (with rename if exists)
  function getThemeLabel(themeId) {
    const id = String(themeId);
    if (themeRenames[id]) {
      return themeRenames[id];
    }
    const t = themeById(themeId);
    return t?.label || `Theme ${themeId}`;
  }
  
  // Update theme label everywhere
  function updateThemeLabelInUI(themeId, newLabel) {
    const id = String(themeId);
    
    // Update in dashboardV2
    if (dashboardV2?.themes?.byId?.[id]) {
      dashboardV2.themes.byId[id].label = newLabel;
    }
    
    // Update charts
    if (themeChartInstance) {
      const chartData = themeChartInstance.data;
      const themeIndex = chartData.ids?.indexOf(Number(id));
      if (themeIndex !== undefined && themeIndex >= 0) {
        chartData.labels[themeIndex] = newLabel;
        themeChartInstance.update();
      }
    }
    
    // Update scatter chart
    if (scatterChartInstance) {
      // Scatter chart labels are drawn manually, will update on next render
      plotScatterChart(coordinatesForScatter());
    }
    
    // Update document table
    docsArray = docsForTable();
    renderDocumentTable(docsArray);
    populateThemeFilter(docsArray);
    // Clear theme docs cache when documents change
    themeDocsCache.clear();
    
    // Update diagnostics table
    populateThemeDiagnosticsTable(diagnosticsForTable());
    
    // Update document detail modal if it's currently open and showing this theme
    const docDetailModal = document.getElementById("docDetailModal");
    if (docDetailModal && docDetailModal.classList.contains("show")) {
      const modalThemeEl = document.getElementById("modalTheme");
      if (modalThemeEl) {
        // Check if the current document's theme matches the renamed theme
        const currentThemeId = modalThemeEl.dataset.themeId;
        if (currentThemeId && String(currentThemeId) === id) {
          modalThemeEl.textContent = newLabel;
        }
      }
      
      // Update the chart in document detail modal - refresh all labels with renamed ones
      if (window.lastDocInferenceData) {
        const updatedData = window.lastDocInferenceData.map(theme => ({
          ...theme,
          label: theme.theme_id != null ? getThemeLabel(theme.theme_id) : theme.label
        }));
        renderDocInformationChart(updatedData, "docInferenceChart");
      }
    }
  }


  // ---------------------------
  // Theme modal - Optimized
  // ---------------------------
  // Cache for filtered documents by theme
  const themeDocsCache = new Map();
  
  // Cache DOM element references
  let modalElementsCache = null;
  function getModalElements() {
    if (!modalElementsCache) {
      modalElementsCache = {
        modalContent: document.getElementById("themeModalContent"),
        modalTitle: document.getElementById("selectedThemeLabel"),
        themeTitleText: document.getElementById("themeTitleText"),
        renameBtn: document.getElementById("renameThemeBtn"),
        renameControls: document.getElementById("renameControls"),
        renameInput: document.getElementById("renameThemeInput"),
        saveBtn: document.getElementById("saveRenameBtn"),
        cancelBtn: document.getElementById("cancelRenameBtn"),
        summaryEl: document.getElementById("selectedThemeSummary"),
        diagContainer: document.getElementById("themeDiagnosticsGrid"),
        kwContainer: document.getElementById("selectedThemeKeywords"),
        modalEl: document.getElementById("themeDetailModal"),
        panels: document.querySelectorAll("#themeDetailModal .panel")
      };
    }
    return modalElementsCache;
  }

  // Setup rename handlers once (using event delegation)
  let renameHandlersSetup = false;
  let currentThemeContext = { themeId: null, currentLabel: null };
  
  function setupRenameHandlers() {
    if (renameHandlersSetup) return;
    renameHandlersSetup = true;
    
    const els = getModalElements();
    if (!els.renameBtn || !els.renameInput || !els.saveBtn || !els.cancelBtn) return;
    
    els.renameBtn.addEventListener("click", () => {
      els.renameBtn.style.display = "none";
      els.renameControls.style.display = "flex";
      els.renameInput.value = currentThemeContext.currentLabel;
      els.renameInput.focus();
      els.renameInput.select();
    });
    
    const saveRename = async () => {
      const newLabel = els.renameInput.value.trim();
      const { themeId, currentLabel } = currentThemeContext;
      if (newLabel && newLabel !== currentLabel && themeId !== null) {
        // Update in-memory immediately for UI responsiveness
        themeRenames[String(themeId)] = newLabel;
        updateThemeLabelInUI(themeId, newLabel);
        
        // Update modal title text and context
        if (els.themeTitleText) els.themeTitleText.textContent = newLabel;
        currentThemeContext.currentLabel = newLabel;
        
        // Send to backend API
        const modelId = document.getElementById("model_id")?.textContent?.trim() || "";
        if (modelId) {
          try {
            const response = await fetch(`/api/models/${modelId}/topics/${themeId}/rename`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ new_label: newLabel })
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log("Topic renamed successfully:", result);
            } else {
              console.error("Failed to save topic rename to backend:", await response.text());
            }
          } catch (error) {
            console.error("Error saving topic rename to backend:", error);
          }
        }
      }
      els.renameBtn.style.display = "inline-flex";
      els.renameControls.style.display = "none";
    };
    
    els.saveBtn.addEventListener("click", saveRename);
    els.renameInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") saveRename();
      if (e.key === "Escape") {
        els.renameBtn.style.display = "inline-flex";
        els.renameControls.style.display = "none";
      }
    });
    
    els.cancelBtn.addEventListener("click", () => {
      els.renameBtn.style.display = "inline-flex";
      els.renameControls.style.display = "none";
    });
  }

  function openThemeModal(themeId, themeColor) {
    const t = themeById(themeId);
    if (!t) return;

    const els = getModalElements();
    setupRenameHandlers();
    
    const currentLabel = getThemeLabel(themeId);
    
    // Update cached theme context for rename handlers
    currentThemeContext.themeId = themeId;
    currentThemeContext.currentLabel = currentLabel;
    
    if (els.modalContent) {
      els.modalContent.style.backgroundColor = lightBgFromColor(themeColor);
    }
    
    if (els.modalTitle) {
      els.modalTitle.style.color = themeColor;
      els.modalTitle.style.borderLeft = `6px solid ${themeColor}`;
      els.modalTitle.style.paddingLeft = "0.5rem";
    }
    
    if (els.themeTitleText) {
      els.themeTitleText.textContent = currentLabel;
    }
    
    // Show rename button, hide input controls
    if (els.renameBtn) els.renameBtn.style.display = "inline-flex";
    if (els.renameControls) els.renameControls.style.display = "none";

    // Update panel borders (batch operation)
    if (els.panels) {
      els.panels.forEach(panel => {
        panel.style.borderColor = themeColor;
        panel.style.boxShadow = `0 0 0 1px ${themeColor}`;
      });
    }

    // Summary
    if (els.summaryEl) {
      els.summaryEl.textContent = t.summary || "â€”";
    }

    // Diagnostics grid - optimized with DocumentFragment
    const d = diagByThemeId(themeId) || {};
    if (els.diagContainer) {
      els.diagContainer.classList.add("row", "row-cols-2", "g-2");
      
      const fragment = document.createDocumentFragment();
      const keys = getActiveDiagnosticKeys();
      let hasItems = false;
      
      keys.forEach(k => {
        const v = d[k];
        if (v == null || (typeof v === "number" && Number.isNaN(v))) return;
        hasItems = true;
        const div = document.createElement("div");
        div.className = "col";
        const cardDiv = document.createElement("div");
        cardDiv.className = "border rounded p-3 bg-light-subtle h-100 small";
        cardDiv.style.borderColor = themeColor;
        cardDiv.style.backgroundColor = lightBgFromColor(themeColor);
        cardDiv.innerHTML = `
          <strong>${prettyLabel(k)}</strong>
          <div class="text-muted mt-1" style="font-size: 1rem; font-weight: 600;">${fmtValue(k, v)}</div>`;
        div.appendChild(cardDiv);
        fragment.appendChild(div);
      });

      els.diagContainer.innerHTML = "";
      if (hasItems) {
        els.diagContainer.appendChild(fragment);
      } else {
        els.diagContainer.innerHTML = `<div class="col-12"><div class="border rounded p-2 bg-light-subtle small">No diagnostics available.</div></div>`;
      }
    }

    // Keywords - optimized with DocumentFragment and enhanced styling
    if (els.kwContainer) {
      const fragment = document.createDocumentFragment();
      (t.keywords || []).forEach(k => {
        const badge = document.createElement("span");
        badge.className = "badge bg-light text-dark border";
        badge.style.borderColor = themeColor;
        badge.style.color = themeColor;
        badge.style.backgroundColor = lightBgFromColor(themeColor);
        badge.textContent = k;
        fragment.appendChild(badge);
      });
      els.kwContainer.innerHTML = "";
      els.kwContainer.appendChild(fragment);
    }
    
    // Update summary border color
    if (els.summaryEl) {
      els.summaryEl.style.borderLeftColor = themeColor;
    }

    // Documents for this theme - use cache
    const themeLabel = t.label;
    let themedDocs = themeDocsCache.get(themeLabel);
    if (!themedDocs) {
      themedDocs = docsArray.filter(d => d.theme === themeLabel);
      themeDocsCache.set(themeLabel, themedDocs);
    }
    renderFilteredTable(themedDocs);

    // Similarities
    renderThemeSimilarityChart(similaritiesForTheme(themeId));

    if (els.modalEl) bringModalToFront(els.modalEl);
  }

  function renderFilteredTable(filters = []) {
    const thead = document.getElementById("filteredTableHead");
    const tbody = document.getElementById("filteredTableBody");
    if (!thead || !tbody) return;
    
    // Clear existing content
    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (filters.length === 0) {
      thead.innerHTML = `<tr class="small"><th>No data</th></tr>`;
      tbody.innerHTML = `<tr class="small"><td class="text-muted">No documents to display.</td></tr>`;
      return;
    }

    const baseColumns = ["id", "text", "score"];
    const hasRationale = filters.some(f => f.hasOwnProperty("rationale"));
    const columns = hasRationale ? [...baseColumns, "rationale"] : baseColumns;

    // Build header
    const headerRow = document.createElement("tr");
    headerRow.classList.add("small");
    columns.forEach(col => {
      const th = document.createElement("th");
      th.classList.add("small");
      th.textContent = col.charAt(0).toUpperCase() + col.slice(1);
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    // Sort once before rendering
    const sortedFilters = filters.slice().sort((a, b) => (b.score ?? 0) - (a.score ?? 0));
    
    // Use DocumentFragment for batch DOM operations
    const fragment = document.createDocumentFragment();
    
    sortedFilters.forEach(filter => {
      const row = document.createElement("tr");
      row.classList.add("small");
      row.dataset.search = [filter.id, filter.text, String(filter.score ?? ""), filter.rationale ?? ""].join(" ").toLowerCase();
      row.addEventListener("click", () => showDocumentInfoModal?.(filter));

      columns.forEach(col => {
        const td = document.createElement("td");
        td.classList.add("small", "truncate-cell");
        let value = filter[col];
        if (col === "score" && typeof value === "number") value = value.toFixed(3);
        td.textContent = value ?? "â€”";
        td.title = td.textContent;
        row.appendChild(td);
      });

      fragment.appendChild(row);
    });
    
    // Single DOM operation
    tbody.appendChild(fragment);
  }


  async function showDocumentInfoModal(doc) {
    const docId = doc.id;
    const modelId   = document.getElementById("model_id")?.textContent?.trim() || "";

    const response = await fetch("/text-info", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model_id: modelId,
        document_id: String(doc.id)
      })
    });

    if (!response.ok) {
      console.error(await response.text());
      alert("Failed to infer topic.");
      return;
    }

    const result = await response.json();

    const fullTextEl = document.getElementById("modalFullText");
    const themeEl    = document.getElementById("modalTheme");
    if (fullTextEl) fullTextEl.textContent = result.text || doc.text || "â€”";
    if (themeEl)    themeEl.textContent    = result.theme || "â€”";

    // theme color
    const top = result?.top_themes?.[0];
    const resolvedThemeId = top?.theme_id != null ? Number(top.theme_id) : null;
    const inferredThemeColor = resolvedThemeId != null ? (themeColorMap[resolvedThemeId] || null) : null;

    if (themeEl) {
      themeEl.style.color = inferredThemeColor || "";       
      themeEl.style.fontWeight = inferredThemeColor ? "600" : "";
    }

    const topTheme = result.top_themes?.[0];
    const keywordsRaw = topTheme?.keywords || "â€”";
    const formatted = typeof keywordsRaw === "string"
      ? keywordsRaw.split(", ").reduce((acc, word, idx) => {
          const line = Math.floor(idx / 5);
          acc[line] = acc[line] ? acc[line] + ", " + word : word;
          return acc;
        }, []).join("\n")
      : keywordsRaw;

    const kwEl = document.getElementById("modalKeywords");
    if (kwEl) kwEl.textContent = formatted;

    // rationale
    const rationaleText = (result?.rationale || "").trim();
    const rationaleEl = document.getElementById("modalRationale");
    const rationaleWrapper = document.getElementById("rationalDiv");
    if (rationaleEl && rationaleWrapper) {
      if (rationaleText) {
        rationaleEl.textContent = rationaleText;
        rationaleWrapper.style.display = "";
      } else {
        rationaleEl.textContent = "â€”";
        rationaleWrapper.style.display = "none";
      }
    }

    renderDocInformationChart(result.top_themes);
    const docThemeId = resolvedThemeId;

    const grid = ensureDocDiagnosticsBlock();
    if (grid && docThemeId != null) {
      grid.innerHTML = "";
      const d = diagByThemeId(docThemeId) || {};
      const keys = getActiveDiagnosticKeys();
      keys.forEach(k => {
        const v = d[k];
        if (v == null || (typeof v === "number" && Number.isNaN(v))) return;
        const col = document.createElement("div");
        col.className = "col";
        col.innerHTML = `
          <div class="border rounded p-2 bg-light-subtle h-100 small">
            <strong>${prettyLabel(k)}:</strong>
            <span class="text-muted">${fmtValue(k, v)}</span>
          </div>`;
        grid.appendChild(col);
      });
      if (!grid.children.length) {
        grid.innerHTML = `<div class="col-12"><div class="border rounded p-2 bg-light-subtle small">No diagnostics for this document.</div></div>`;
      }
    }

    const modal = document.getElementById("docDetailModal");
    if (modal) bringModalToFront(modal);
  }

  // ---------------------------
  // Model details
  // ---------------------------
  function showModelDetails(name) {
    if (!dashboardV2) {
      alert("Model details are unavailable until the dashboard data loads.");
      return;
    }
    let info = null;
    if (dashboardV2.modelInfos && typeof dashboardV2.modelInfos === "object") {
      info = dashboardV2.modelInfos[name] || null;
      if (!info) {
        const keys = Object.keys(dashboardV2.modelInfos);
        if (keys.length === 1) info = dashboardV2.modelInfos[keys[0]];
      }
    } else if (dashboardV2.modelInfo) {
      info = dashboardV2.modelInfo;
    }
    if (!info) {
      alert("No model details found in the loaded data.");
      return;
    }
    renderModelInfoModal(info);
  }
  window.showModelDetails = showModelDetails;

  function renderModelInfoModal(model) {
    const modalBody = document.getElementById("modelDetailBody");
    if (!modalBody) return;

    const trainingParamsHTML = model.training_params && Object.keys(model.training_params).length
      ? Object.entries(model.training_params).map(([k, v]) => `
          <div class="row mb-1">
            <div class="col-4 text-muted small">${k}:</div>
            <div class="col-8 small">${String(v)}</div>
          </div>
        `).join("")
      : `<div class="text-muted small">No training parameters found.</div>`;

    const trainingMetricsHTML = model.training_metrics && Object.keys(model.training_metrics).length
      ? `
        <hr />
        <h6 class="fw-semibold">Training Metrics</h6>
        ${Object.entries(model.training_metrics).map(([k, v]) => `
          <div class="row mb-1">
            <div class="col-4 text-muted small">${k}:</div>
            <div class="col-8 small">${typeof v === "number" ? v.toFixed(3) : String(v)}</div>
          </div>
        `).join("")}
      `
      : "";

    modalBody.innerHTML = `
      <div class="row mb-2">
        <div class="col-4 fw-semibold text-muted">Model Name:</div>
        <div class="col-8">${model.model_name}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-semibold text-muted">Type:</div>
        <div class="col-8">${model.model_type}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-semibold text-muted">Number of Topics:</div>
        <div class="col-8">${model.num_topics}</div>
      </div>
      <div class="row mb-2">
        <div class="col-4 fw-semibold text-muted">Trained On:</div>
        <div class="col-8">${model.trained_on}</div>
      </div>

      <hr />
      <p class="text-muted small">
        This model was trained on a cleaned dataset of unstructured documents using 
        <strong>${model.num_topics}-topic ${model.model_type}</strong>. Use the chart and panels below to explore the results.
      </p>

      <hr />
      <h6 class="fw-semibold">Training Parameters</h6>
      ${trainingParamsHTML}
      ${trainingMetricsHTML}
    `;

    const modalEl = document.getElementById("modelInfoModal");
    if (modalEl) bringModalToFront(modalEl);
  }


  async function fetchDashboard(modelId) {
    console.log("this is the model id:", modelId);

    const res = await fetch("/get-dashboard-data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({model_id: modelId})
    });
    if (!res.ok) throw new Error(`Dashboard fetch failed: ${res.status}`);
    return res.json();
  }

  (async () => {
    try {
      const modelId = document.getElementById("model_id")?.textContent?.trim() || "";
      
      // Load renames from backend (will reset to backend state on each reload)
      await loadThemeRenames();
      
      dashboardV2 = await fetchDashboard(modelId);

      const themeArray = themesForChart();
      themeArray.forEach((t, i) => { themeColorMap[t.id] = t.color || computeColor(i, dashboardV2.color); });

      renderThemeChart(createThemeChartData(themeArray));
      plotScatterChart(coordinatesForScatter());

      docsArray = docsForTable();
      renderDocumentTable(docsArray);
      populateThemeFilter(docsArray);

      populateThemeDiagnosticsTable(diagnosticsForTable());
      renderThemeMetrics(dashboardV2.metrics || []);

      // Bar/Grid toggle
      const barChart = document.getElementById("themeChart");
      const gridChart = document.getElementById("themeChartGrid");
      const toggleBtn = document.getElementById("toggleChartBtn");
      if (toggleBtn && barChart && gridChart) {
        toggleBtn.addEventListener("click", () => {
          const showingBar = !barChart.hidden;
          barChart.hidden = showingBar;
          gridChart.hidden = !showingBar;
          toggleBtn.textContent = showingBar ? "Switch to Bar Chart" : "Switch to Grid View";
        });
      }


      // ---------------------------
      // Inference modal 
      // ---------------------------
      (() => {
        const toggleTextBtn = document.getElementById("toggleTextInput");
        const toggleFileBtn = document.getElementById("toggleFileInput");
        const textArea = document.getElementById("textAreaSpace");
        const fileGroup = document.getElementById("fileInputGroup");
        const inferredBlock = document.getElementById("inferredResults");
        const inferBtn = document.getElementById("inferBtn");
        const inputText = document.getElementById("inputText");
        const fileInput = document.getElementById("files");
        const textSelect = document.getElementById("textColumn");
        const idSelect = document.getElementById("idColumn");
        const statusEl = document.getElementById("inferStatus");

        if (!toggleTextBtn || !toggleFileBtn || !textArea || !fileGroup || !inferBtn) return;

        let madeInference = false;
        let mode = "text";
        let cachedFileContent = "";
        let cachedFileExt = "";

        const setLoading = (loading, label = "Infer") => {
          inferBtn.disabled = loading;
          inferBtn.textContent = loading ? "Running..." : label;
        };

        const showStatus = (msg, isError = false) => {
          if (!statusEl) return;
          statusEl.textContent = msg || "";
          statusEl.classList.toggle("text-danger", !!isError);
          statusEl.classList.toggle("text-muted", !isError);
        };

        const setOptions = (selectEl, options) => {
          if (!selectEl) return;
          selectEl.innerHTML = "";
          const placeholder = document.createElement("option");
          placeholder.disabled = true;
          placeholder.selected = true;
          placeholder.textContent = "Select column...";
          selectEl.appendChild(placeholder);
          (options || []).forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            selectEl.appendChild(o);
          });
        };

        const parseHeaderKeys = (content, ext) => {
          try {
            if (ext === "json") {
              const parsed = JSON.parse(content);
              const first = Array.isArray(parsed) ? parsed[0] : parsed;
              return first && typeof first === "object" ? Object.keys(first) : [];
            }
            if (ext === "jsonl") {
              const line = (content.split(/\r?\n/).find((l) => l.trim()) || "").trim();
              if (!line) return [];
              const obj = JSON.parse(line);
              return obj && typeof obj === "object" ? Object.keys(obj) : [];
            }
            if (ext === "csv") {
              const firstLine = (content.split(/\r?\n/).find((l) => l.trim()) || "").trim();
              return firstLine ? firstLine.split(",").map((s) => s.trim()) : [];
            }
            return [];
          } catch {
            return [];
          }
        };

        const parseRecords = (content, ext, idCol, textCol) => {
          const records = [];
          if (!idCol || !textCol) return records;
          try {
            if (ext === "json") {
              const parsed = JSON.parse(content);
              const arr = Array.isArray(parsed) ? parsed : [parsed];
              arr.forEach((row, idx) => {
                if (row && typeof row === "object" && row[textCol]) {
                  records.push({ id: row[idCol] ?? `row-${idx + 1}`, text: row[textCol] });
                }
              });
              return records;
            }
            if (ext === "jsonl") {
              content.split(/\r?\n/).forEach((line, idx) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                try {
                  const obj = JSON.parse(trimmed);
                  if (obj && obj[textCol]) {
                    records.push({ id: obj[idCol] ?? `row-${idx + 1}`, text: obj[textCol] });
                  }
                } catch {
                  /* ignore bad line */
                }
              });
              return records;
            }
            if (ext === "csv") {
              const lines = content.split(/\r?\n/).filter((l) => l.trim());
              if (!lines.length) return records;
              const header = lines[0].split(",").map((s) => s.trim());
              const idIdx = header.indexOf(idCol);
              const textIdx = header.indexOf(textCol);
              if (idIdx === -1 || textIdx === -1) return records;
              for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(",").map((s) => s.trim());
                const text = cols[textIdx];
                if (!text) continue;
                const id = cols[idIdx] || `row-${i}`;
                records.push({ id, text });
              }
              return records;
            }
            // fallback: treat as plain text (one record)
            if (content.trim()) {
              records.push({ id: "1", text: content.trim() });
            }
            return records;
          } catch {
            return records;
          }
        };

        function renderDocInference(result) {
          const inferredThemeEl = document.getElementById("inferredTheme");
          const inferredKeywordsEl = document.getElementById("inferredKeywords");
          const infRationaleEl = document.getElementById("inferredRationale");
          const infRationaleWrapper = document.getElementById("inferredRationaleWrapper");
          const textArea = document.getElementById("textAreaSpace");
          const inferredBlock = document.getElementById("inferredResults");

          const safeThemeById = (tid) => {
            try {
              return dashboardV2?.themes?.byId?.[String(tid)] || null;
            } catch {
              return null;
            }
          };

          console.log(result)

          let topThemes = [];
          const thetas = result?.thetas;
          if (Array.isArray(thetas) && thetas.length) {
            const firstEntry = thetas[0] || {};
            const [, themeScoresObj] = Object.entries(firstEntry)[0] || [];
            if (themeScoresObj && typeof themeScoresObj === "object") {
              topThemes = Object.entries(themeScoresObj)
                .map(([tid, score]) => {
                  const t = safeThemeById(tid);
                  return {
                    theme_id: Number(tid),
                    label: getThemeLabel(tid),
                    score: typeof score === "number" ? score : Number(score) || 0,
                    keywords: Array.isArray(t?.keywords) ? t.keywords.join(", ") : (t?.keywords || "")
                  };
                })
                .sort((a, b) => (b.score ?? 0) - (a.score ?? 0));
            }
          }

          const top = topThemes[0] || null;
          const inferredColor = top?.theme_id != null ? (themeColorMap[Number(top.theme_id)] || null) : null;

          if (inferredThemeEl) {
            inferredThemeEl.textContent = top?.label || "-";
            inferredThemeEl.style.color = inferredColor || "";     
            inferredThemeEl.style.fontWeight = inferredColor ? "600" : "";
          }

          // No rationale in this response; hide it
          if (infRationaleEl && infRationaleWrapper) {
            infRationaleEl.textContent = "â€”";
            infRationaleWrapper.style.display = "none";
          }

          if (inferredKeywordsEl) {
            const kw = top?.keywords || "";
            const formatted = typeof kw === "string"
              ? kw.split(", ").reduce((acc, word, idx) => {
                  const line = Math.floor(idx / 5);
                  acc[line] = acc[line] ? acc[line] + ", " + word : word;
                  return acc;
                }, []).join("\n")
              : "";
            inferredKeywordsEl.textContent = formatted || "â€”";
          }

          renderDocInformationChart(
            topThemes.map(t => ({
              ...t,
              keywords: t.keywords || ""
            })),
            "inferredThemeChart"
          );

          if (textArea) textArea.className = "col-md-6";
          if (inferredBlock) inferredBlock.style.display = "block";

          return topThemes;
        }

        const handleFileChange = async () => {
          const file = fileInput?.files?.[0];
          if (!file) return;
          const ext = (file.name.split(".").pop() || "").toLowerCase();
          cachedFileExt = ext;
          cachedFileContent = await file.text();
          const keys = parseHeaderKeys(cachedFileContent, ext);
          if (keys.length) {
            setOptions(textSelect, keys);
            setOptions(idSelect, keys);
            showStatus("Columns detected. Choose text and id columns.", false);
          } else {
            showStatus("Could not detect columns. Please select manually or use text input.", true);
          }
        };

        toggleTextBtn.addEventListener("click", () => {
          mode = "text";
          textArea.style.display = "block";
          fileGroup.style.display = "none";
          toggleTextBtn.classList.add("active");
          toggleFileBtn.classList.remove("active");
          if (madeInference && inferredBlock) inferredBlock.style.display = "block";
        });
        toggleFileBtn.addEventListener("click", () => {
          mode = "file";
          textArea.style.display = "none";
          fileGroup.style.display = "block";
          toggleFileBtn.classList.add("active");
          toggleTextBtn.classList.remove("active");
          if (inferredBlock) inferredBlock.style.display = "none";
        });
        fileInput?.addEventListener("change", handleFileChange);

        if (inferBtn) {
          inferBtn.addEventListener("click", async () => {
            showStatus("");
            const payload = {
              model_id: modelId,
              id_col: "id",
              text_col: "text",
              config_path: "static/config/config.yaml",
              data: []
              // owner_id could be added here if supported by backend
            };

            try {
              setLoading(true);
              if (mode === "file") {
                const file = fileInput?.files?.[0];
                const idCol = idSelect?.value;
                const textCol = textSelect?.value;
                if (!file) throw new Error("Please choose a file.");
                if (!idCol || !textCol) throw new Error("Select ID and Text columns.");
                if (!cachedFileContent) cachedFileContent = await file.text();
                const records = parseRecords(cachedFileContent, cachedFileExt || (file.name.split(".").pop() || "").toLowerCase(), idCol, textCol);
                if (!records.length) throw new Error("No rows found with the selected columns.");
                payload.data = records.map((r) => ({ id: r.id, text: r.text }));
              } else {
                const text = inputText?.value.trim() || "";
                if (!text) throw new Error("Please enter some text.");
                payload.data = [{ id: "1", text }];
                console.log(payload);
              }

              const response = await fetch("/infer-text", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!response.ok) throw new Error(`Failed to fetch inference (${response.status})`);
              const rawResult = await response.json();
              console.log(rawResult)
              const result = rawResult?.results || rawResult?.result || rawResult || {};

              renderDocInference(result);
              madeInference = true;
              showStatus("Inference complete.");
            } catch (err) {
              console.error("Inference error:", err);
              showStatus(err?.message || "Failed to perform inference.", true);
              alert("Failed to perform inference.");
            } finally {
              setLoading(false);
            }
          });
        }
      })();

      // Metrics toggle (Theme vs Model)
      (function metricsToggle() {
        const btn   = document.getElementById("toggleMetricBtn");
        const theme = document.getElementById("themeMetricsPanel");
        const model = document.getElementById("modelMetricsPanel");
        if (!btn || !theme || !model) return;

        let isThemeView = !theme.classList.contains("d-none");
        function render() {
          theme.classList.toggle("d-none", !isThemeView);
          model.classList.toggle("d-none",  isThemeView);
          btn.textContent = isThemeView ? "Switch to Model Metrics" : "Switch to Theme Metrics";
          btn.setAttribute("aria-pressed", String(!isThemeView));
        }
        btn.addEventListener("click", () => { isThemeView = !isThemeView; render(); });
        render();
      })();

      // Fullscreen chart helpers
      window.openFullChart = function (originalChartId) {
        const originalCanvas = document.getElementById(originalChartId);
        const fullCanvas = document.getElementById('fullChartCanvas');
        const fullModalEl = document.getElementById('fullChartModal');
        if (!originalCanvas || !fullCanvas || !fullModalEl) return;

        const originalChart = Chart.getChart(originalCanvas);
        if (!originalChart) return;

        let clonedData;
        try { clonedData = structuredClone(originalChart.config.data); }
        catch(e) { clonedData = JSON.parse(JSON.stringify(originalChart.config.data)); }

        const originalOptions = originalChart.config.options || {};
        const clonedOptions = {
          ...originalOptions,
          onClick: null,
          plugins: {
            ...originalOptions.plugins,
            datalabels: {
              anchor: 'end',
              align: 'top',
              font: { weight: 'bold' },
              formatter: function(value, context) {
                const labels = context.chart.data.labels;
                if (labels && labels[context.dataIndex]) return labels[context.dataIndex];
                const point = context.dataset.data[context.dataIndex];
                return point?.label || 'Label';
              }
            }
          }
        };

        if (window.fullChartInstance) window.fullChartInstance.destroy();

        const modal = new bootstrap.Modal(fullModalEl, { backdrop: false, focus: false });
        const onShown = () => {
          window.fullChartInstance = new Chart(fullCanvas.getContext('2d'), {
            type: originalChart.config.type,
            data: clonedData,
            options: clonedOptions,
            plugins: [ChartDataLabels]
          });
          fullModalEl.removeEventListener('shown.bs.modal', onShown);
        };
        fullModalEl.addEventListener('shown.bs.modal', onShown);
        bringModalToFront(fullModalEl);
      };

      window.openVisibleThemeChart = function () {
        const canvasA = document.getElementById('themeChart');
        const canvasB = document.getElementById('themeChartGrid');
        const visibleCanvas = !canvasA?.hidden ? canvasA : !canvasB?.hidden ? canvasB : null;
        if (visibleCanvas) window.openFullChart(visibleCanvas.id);
      };

    } catch (err) {
      console.error(err);
      alert("Failed to load dashboard.");
    }
  })();

  // ---------------------------
  // Save preferences modal (autoshow after 5 minutes)
  // ---------------------------
  (function savePrefs() {
    const SAVE_DELAY_MS = 5 * 60 * 1000;     // 5 minutes
    const SESSION_KEY   = "savePrefsDismissed";

    function ensureSaveSettingsModal() {
      if (document.getElementById("saveSettingsModal")) return;

      document.body.insertAdjacentHTML("beforeend", `
        <div class="modal fade" id="saveSettingsModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form id="saveSettingsForm">
                <div class="modal-header">
                  <h5 class="modal-title">Save preferences</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                  <p class="mb-2 small text-muted">Choose what you'd like to save:</p>

                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="saveModel" name="saveModel">
                    <label class="form-check-label" for="saveModel">Save <strong>Model</strong></label>
                  </div>

                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="saveCorpus" name="saveCorpus">
                    <label class="form-check-label" for="saveCorpus">Save <strong>Corpus</strong></label>
                  </div>

                  <div class="form-text">You can change this later in settings.</div>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" id="saveNotNowBtn" data-bs-dismiss="modal">Not now</button>
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>`);

      document.getElementById("saveNotNowBtn")?.addEventListener("click", () => {
        try { sessionStorage.setItem(SESSION_KEY, "1"); } catch {}
      });

      document.getElementById("saveSettingsForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const saveModel  = document.getElementById("saveModel")?.checked || false;
        const saveCorpus = document.getElementById("saveCorpus")?.checked || false;

        const modelId = document.getElementById("model_id")?.textContent?.trim() || "";
        const modelInfo =
          window.dashboardV2?.modelInfo ||
          (window.dashboardV2?.modelInfos && window.dashboardV2.modelInfos[modelId]) ||
          null;

        const payload = {
          model_id: modelId,
          save: { model: !!saveModel, corpus: !!saveCorpus },
          meta: {
            theme_count: window.dashboardV2?.themes?.allIds?.length ?? null,
            document_count: window.dashboardV2?.documents?.allIds?.length ?? null,
            num_topics: modelInfo?.num_topics ?? null,
            corpus_name: modelInfo?.trained_on ?? null,
          },
          ts: new Date().toISOString()
        };

        try {
          const res = await fetch("/save-settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error(`Save failed: ${res.status}`);
          const modalEl = document.getElementById("saveSettingsModal");
          bootstrap.Modal.getInstance(modalEl)?.hide();
        } catch (err) {
          console.error(err);
          alert("Failed to save your preference. Please try again.");
        }
      });
    }

    function openSaveSettingsModal() {
      ensureSaveSettingsModal();
      const el = document.getElementById("saveSettingsModal");
      if (el) bringModalToFront(el);
    }
    window.openSaveSettingsModal = openSaveSettingsModal;

    // Auto-show after delay unless dismissed
    try {
      if (!sessionStorage.getItem(SESSION_KEY)) {
        setTimeout(() => {
          if (!sessionStorage.getItem(SESSION_KEY)) openSaveSettingsModal();
        }, SAVE_DELAY_MS);
      }
    } catch {
      setTimeout(openSaveSettingsModal, SAVE_DELAY_MS);
    }
  })();

  // ---------------------------
  // Metrics panel toggle (ensure button works even if initial DOM classes differ)
  // ---------------------------
  (function metricsToggleOnce() {
    const btn   = document.getElementById("toggleMetricBtn");
    const theme = document.getElementById("themeMetricsPanel");
    const model = document.getElementById("modelMetricsPanel");
    if (!btn || !theme || !model) return;

    let isThemeView = !theme.classList.contains("d-none");
    function render() {
      theme.classList.toggle("d-none", !isThemeView);
      model.classList.toggle("d-none",  isThemeView);
      btn.textContent = isThemeView ? "Switch to Model Metrics" : "Switch to Theme Metrics";
      btn.setAttribute("aria-pressed", String(!isThemeView));
    }
    btn.addEventListener("click", () => { isThemeView = !isThemeView; render(); });
    render();
  })();

  // Expose for other inline handlers
  window.openThemeModal = openThemeModal;

  // ---------------------------
  // Chat Interface Functionality
  // ---------------------------
  (function initChatInterface() {
    const chatSidebar = document.getElementById("chatSidebar");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const chatWidgetBtn = document.getElementById("chatWidgetBtn");
    const chatSidebarClose = document.getElementById("chatSidebarClose");

    // Ensure chat widget button is visible
    if (chatWidgetBtn) {
      chatWidgetBtn.style.display = "flex";
      chatWidgetBtn.style.visibility = "visible";
      chatWidgetBtn.style.opacity = "1";
    }

    if (!chatSidebar || !chatMessages || !chatInput || !chatSendBtn) {
      console.error("Chat interface elements not found");
      return;
    }

    // Toggle sidebar
    const chatSidebarBackdrop = document.getElementById("chatSidebarBackdrop");
    const mainContent = document.getElementById("mainContent");
    
    function toggleSidebar() {
      const isOpen = chatSidebar.classList.contains("open");
      if (isOpen) {
        chatSidebar.classList.remove("open");
        if (chatSidebarBackdrop) chatSidebarBackdrop.classList.remove("show");
        chatWidgetBtn.classList.remove("sidebar-open");
        // Reset main content padding
        if (mainContent) {
          mainContent.style.paddingRight = "";
        }
      } else {
        chatSidebar.classList.add("open");
        // Show backdrop only on mobile
        if (window.innerWidth <= 991.98 && chatSidebarBackdrop) {
          chatSidebarBackdrop.classList.add("show");
        }
        chatWidgetBtn.classList.add("sidebar-open");
        // Adjust main content padding to make room for sidebar (desktop only)
        if (window.innerWidth > 991.98 && mainContent) {
          mainContent.style.paddingRight = "550px";
        }
        chatInput.focus();
        updateChatModelName();
      }
    }

    // Handle window resize
    let resizeTimer;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const isOpen = chatSidebar.classList.contains("open");
        if (isOpen) {
          if (window.innerWidth <= 991.98) {
            // Mobile: show backdrop, no padding
            if (chatSidebarBackdrop) chatSidebarBackdrop.classList.add("show");
            if (mainContent) mainContent.style.paddingRight = "";
          } else {
            // Desktop: hide backdrop, add padding
            if (chatSidebarBackdrop) chatSidebarBackdrop.classList.remove("show");
            if (mainContent) mainContent.style.paddingRight = "550px";
          }
        }
      }, 250);
    });

    // Event listeners for toggle
    if (chatWidgetBtn) {
      chatWidgetBtn.addEventListener("click", toggleSidebar);
    }
    if (chatSidebarClose) {
      chatSidebarClose.addEventListener("click", toggleSidebar);
    }
    // Close sidebar when clicking backdrop
    if (chatSidebarBackdrop) {
      chatSidebarBackdrop.addEventListener("click", toggleSidebar);
    }

    // Function to add a message to the chat
    function addMessage(text, isUser = false) {
      const messageDiv = document.createElement("div");
      messageDiv.className = "chat-message mb-3";
      
      if (isUser) {
        messageDiv.innerHTML = `
          <div class="d-flex align-items-start justify-content-end">
            <div class="flex-grow-1 text-end">
              <div class="user-message-bubble d-inline-block">
                <p>${escapeHtml(text)}</p>
              </div>
            </div>
            <div class="flex-shrink-0 ms-2">
              <div class="user-avatar">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16">
                  <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                </svg>
              </div>
            </div>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="d-flex align-items-start">
            <div class="flex-shrink-0 me-2">
              <div class="assistant-avatar">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 24 24">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                  <circle cx="8" cy="10" r="1.5" fill="white"/>
                  <circle cx="12" cy="10" r="1.5" fill="white"/>
                  <circle cx="16" cy="10" r="1.5" fill="white"/>
                </svg>
              </div>
            </div>
            <div class="flex-grow-1">
              <div class="assistant-message-bubble">
                <span class="message-label">Model Assistant</span>
                <p>${escapeHtml(text)}</p>
              </div>
            </div>
          </div>
        `;
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Simple HTML escape function
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Function to send a message
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      // Add user message to chat
      addMessage(message, true);
      chatInput.value = "";

      try {
        const modelId = document.getElementById("model_id")?.textContent?.trim() || "";
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: message,
            model_id: modelId,
            context: {
              themes: dashboardV2?.themes?.allIds?.map(id => {
                const t = themeById(id);
                return { id: t?.id, label: getThemeLabel(id), keywords: t?.keywords || [] };
              }) || [],
              document_count: dashboardV2?.documents?.allIds?.length || 0
            }
          })
        });
        
        if (!response.ok) {
          throw new Error(`Chat API error: ${response.status}`);
        }
        
        const data = await response.json();
        addMessage(data.response || "I'm sorry, I couldn't generate a response.");
      } catch (error) {
        console.error("Chat error:", error);
        addMessage("Sorry, I encountered an error. Please try again.");
      }
    }

    // Event listeners
    chatSendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Quick action buttons
    document.querySelectorAll(".quick-action-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const prompt = btn.getAttribute("data-prompt");
        if (prompt) {
          chatInput.value = prompt;
          chatInput.focus();
          // Optionally auto-send or let user edit first
        }
      });
    });

    // Function to update chat sidebar model name
    function updateChatModelName() {
      const modelId = document.getElementById("model_id")?.textContent?.trim();
      const modelNameEl = document.getElementById("chatModelName");
      if (!modelNameEl) return;
      
      // Get model name from dashboard data
      let modelName = "Unknown Model";
      if (dashboardV2) {
        if (dashboardV2.modelInfo && dashboardV2.modelInfo.model_name) {
          modelName = dashboardV2.modelInfo.model_name;
        } else if (dashboardV2.modelInfos && typeof dashboardV2.modelInfos === "object") {
          const keys = Object.keys(dashboardV2.modelInfos);
          if (keys.length > 0) {
            const firstModel = dashboardV2.modelInfos[keys[0]];
            if (firstModel && firstModel.model_name) {
              modelName = firstModel.model_name;
            }
          }
        }
      }
      
      if (modelId) {
        modelNameEl.textContent = `${modelName} (${modelId})`;
      } else {
        modelNameEl.textContent = modelName;
      }
    }
    window.updateChatModelName = updateChatModelName;

    // Update model name when sidebar opens
    const observer = new MutationObserver(() => {
      if (chatSidebar.classList.contains("open")) {
        chatInput.focus();
        updateChatModelName();
      }
    });
    observer.observe(chatSidebar, { attributes: true, attributeFilter: ["class"] });

    // Initial model name update
    updateChatModelName();
  })();
});
</script>

</body>
</html>

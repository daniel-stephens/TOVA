{% extends "base.html" %}

{% block title %}TOVA ¬∑ Training Dashboard{% endblock %}

{% block extra_head %}
<style>
  .xsmall {
    font-size: 0.7rem !important;
  }

  .compact-metric {
    padding: 4px 6px !important;
    margin-bottom: 4px !important;
    border-radius: 4px;
  }

  .truncate-cell {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
    cursor: pointer;
  }

  #docTableBody tr:hover {
    background-color: #f9f9f9;
    cursor: pointer;
  }

  .small-text {
    font-size: 0.85rem;
    line-height: 1.2;
  }

  .panel {
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    padding: 1rem;
    width: 100%;
    box-sizing: border-box;
  }

  .table-scroll-container {
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
  }

  #docDetailModal {
    z-index: 1065;
  }
  .modal-backdrop + .modal-backdrop {
    z-index: 1060;
  }

  #themeStatsTable th,
  #themeStatsTable td {
    padding: 0.3rem 0.5rem !important;
    font-size: 0.85rem;
    vertical-align: middle;
  }
  #themeStatsTable tr {
    line-height: 1.1;
  }

  .table-scroll-wrapper {
    max-height: 100%;
  }

  .panel h6 {
    font-size: 0.8rem;
    margin-bottom: 0.3rem;
  }

  .theme-stripe {
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: 100%;
    background-color: var(--theme-color, #ccc);
    border-top-left-radius: 0.5rem;
    border-bottom-left-radius: 0.5rem;
  }

  .theme-colored-border {
    border-left: 4px solid var(--theme-color, #ccc);
  }

  .theme-bordered .modal-header h5 {
    color: var(--theme-color, #333);
  }

  .training-progress {
    position: relative;
    height: 1.25rem;
    background-color: var(--bs-gray-200);
    border-radius: var(--bs-progress-border-radius, .375rem);
    overflow: hidden;
  }

  .training-progress .indeterminate {
    display: none;
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  .training-progress .indeterminate::before {
    content: "";
    position: absolute;
    height: 100%;
    width: 40%;
    left: -40%;
    background: linear-gradient(90deg, rgba(0,0,0,0),
      rgba(13,110,253,.25), rgba(0,0,0,0));
    animation: indet-slide 1.2s infinite ease-in-out;
  }

  @keyframes indet-slide {
    0%   { left: -40%; }
    50%  { left: 60%; }
    100% { left: 140%; }
  }

  .pulse-dot {
    display: inline-block;
    width: .65rem;
    height: .65rem;
    border-radius: 50%;
    background: #0d6efd;
    animation: pulse 1.2s infinite ease-in-out;
  }
  .pulse-dot.done  { background: #198754; animation: none; }
  .pulse-dot.error { background: #dc3545; animation: none; }

  @keyframes pulse {
    0%   { transform: scale(.9); opacity: .6; }
    50%  { transform: scale(1); opacity: 1; }
    100% { transform: scale(.9); opacity: .6; }
  }

  /* Layout specific to this page */
  .training-status-card {
    margin-bottom: 1rem;
  }

  .training-layout {
    display: flex;
    gap: 1rem;
    height: calc(100vh - 220px); /* nav + status card + footer room */
  }

  .training-left {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 45%;
  }

  .training-right {
    flex: 1 1 auto;
    overflow: hidden;
  }

  .training-right .panel {
    height: 100%;
  }

  .training-doc-table {
    flex-grow: 1;
    overflow: auto;
  }

  @media (max-width: 992px) {
    .training-layout {
      flex-direction: column;
      height: auto;
    }
    .training-left,
    .training-right {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid py-3">

  <!-- Training status card -->
  <div class="card shadow-sm mb-3 training-status-card">
    <div class="card-body py-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <span class="pulse-dot" id="trainingDot" aria-hidden="true"></span>
          <div id="trainingMessage" class="fw-semibold" aria-live="polite">
            Initializing training‚Ä¶
          </div>
        </div>

        <small id="etaText" class="text-muted" aria-live="polite">
          ETA ‚Äî estimating‚Ä¶
        </small>
      </div>

      <div class="progress mt-3 training-progress" role="progressbar" aria-label="Training progress">
        <div id="trainingBar"
             class="progress-bar progress-bar-striped"
             style="width:0%"
             aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          0%
        </div>
        <div id="indeterminateBar" class="indeterminate" aria-hidden="true"></div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="small text-muted mb-0" id="activityLine" aria-live="polite">
          Preparing‚Ä¶
        </div>

        <div id="redirectButtonContainer" class="text-end d-none">
          <button id="goToModelBtn" class="btn btn-success">
            View Trained Models
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main training layout -->
  <div class="training-layout">

    <!-- LEFT COLUMN -->
    <div class="training-left">

      <!-- Theme Overview Panel -->
      <div class="panel" style="flex: 0 0 50%;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="fw-bold mb-0">Theme Overview</h5>
          <!-- Optional glossary button (uses existing modal if you have it) -->
          <button type="button"
                  class="btn btn-link btn-sm text-decoration-none"
                  data-bs-toggle="modal"
                  data-bs-target="#topicModelGuideModal">
            Glossary
          </button>
        </div>
        <div class="flex-grow-1 d-flex position-relative">
          <canvas id="themeChart" class="w-100 h-100 position-absolute"></canvas>
        </div>
      </div>

      <!-- Theme diagnostics / model metrics (currently hidden by default) -->
      <div class="panel d-flex flex-column" style="flex: 1 1 0; min-height: 0;" hidden>
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h6 class="fw-bold text-dark mb-1" style="font-size: 0.9rem;">Theme Diagnostics</h6>
            <p class="text-muted mb-0" style="font-size: 0.75rem;">
              Summary of diagnostics for each theme.
            </p>
          </div>

          <button id="toggleMetricBtn" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-bar-chart-line me-1"></i> Switch to Model Metrics
          </button>
        </div>

        <div id="themeMetricsPanel" class="flex-grow-1 d-flex flex-column" style="max-height: 90%;">
          <div class="table-scroll-wrapper flex-grow-1 border rounded overflow-auto">
            <table class="table table-sm table-hover align-middle mb-0" id="themeStatsTable" style="font-size: 0.75rem;">
              <thead class="table-light sticky-top" style="top: 0; z-index: 1;"></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="modelMetricsPanel" class="d-none flex-grow-1 d-flex flex-column">
          <h6 class="fw-bold mb-3 mt-2">Theme Insights</h6>
          <div id="themeInsightsGrid" class="row row-cols-2 small g-2 flex-grow-1 overflow-auto"></div>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="training-right">
      <div class="panel d-flex flex-column h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold mb-0">Documents</h6>
          <input type="text"
                 id="docSearchInput"
                 class="form-control form-control-sm w-50"
                 placeholder="Search documents...">
        </div>

        <div class="d-flex flex-wrap align-items-end justify-content-between mb-3">
          <p class="text-muted small mb-1" style="font-size: 0.75rem;">
            Click on text to view full text information
          </p>

          <div class="d-flex flex-wrap gap-2 align-items-end ms-auto">
            <div class="form-group">
              <label for="themeFilter" class="form-label mb-0 small">Theme</label>
              <select id="themeFilter" class="form-select form-select-sm">
                <option value="">All Themes</option>
              </select>
            </div>

            <div class="form-group">
              <label for="scoreMin" class="form-label mb-0 small">Min Score</label>
              <input type="number"
                     id="scoreMin"
                     class="form-control form-control-sm"
                     style="width: 100px;"
                     placeholder="0.00"
                     step="0.001">
            </div>

            <div class="form-group">
              <label for="scoreMax" class="form-label mb-0 small">Max Score</label>
              <input type="number"
                     id="scoreMax"
                     class="form-control form-control-sm"
                     style="width: 100px;"
                     placeholder="1.00"
                     step="0.001">
            </div>

            <div class="form-group">
              <button id="filterBtn" class="btn btn-sm btn-primary">
                Apply Filters
              </button>
            </div>
          </div>
        </div>

        <div class="training-doc-table">
          <table class="table table-sm table-hover mb-0">
            <thead id="docTableHead" class="sticky-top bg-white"></thead>
            <tbody id="docTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Modals -->

  <!-- Document detail modal -->
  <div class="modal fade" id="docDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" style="max-height: 100vh;">
      <div class="modal-content d-flex flex-column h-100">
        <div class="modal-header">
          <h5 class="modal-title" id="modalClusterTitle">Cluster ‚Äì</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>

        <div class="modal-body overflow-auto flex-grow-1">
          <div class="mb-4">
            <h6 class="fw-semibold">Theme Keywords</h6>
            <div id="modalKeywords" class="d-flex flex-wrap gap-2 small"></div>
          </div>

          <div>
            <h6 class="fw-semibold">Full Text</h6>
            <div class="border rounded p-3 bg-light-subtle" style="max-height: 60vh; overflow-y: auto;">
              <p id="modalFullText" class="mb-0 small" style="white-space: pre-wrap;"></p>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Training Complete Modal -->
  <div class="modal fade" id="trainingCompleteModal" tabindex="-1"
       aria-labelledby="trainingCompleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title fw-semibold" id="trainingCompleteLabel">
            üéâ Training Complete
          </h5>
          <button type="button" class="btn-close btn-close-white"
                  data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center py-4">
          <p class="fs-6 mb-3">
            Your model has finished training successfully!  
            Click <b>‚ÄúView Trained Models‚Äù</b> to see your models, then select one to open its dashboard.
          </p>
          <i class="bi bi-check-circle-fill text-success fs-1 mb-3"></i>
        </div>
        <div class="modal-footer justify-content-center border-0">
          <button type="button" class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">Close</button>
          <button type="button" id="viewModelsBtn" class="btn btn-success">
            View Trained Models
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Theme detail modal -->
  <div class="modal fade" id="themeDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content position-relative theme-bordered">

        <div class="theme-stripe"></div>

        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="selectedThemeLabel">Theme Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-4 border rounded p-3 theme-colored-border" id="keywordsBox">
            <h6 class="fw-semibold">Top Keywords</h6>
            <div id="selectedThemeKeywords" class="d-flex flex-wrap gap-2 small"></div>
          </div>

          <div class="panel bg-white border rounded p-3 theme-colored-border" id="docsBox">
            <h6 class="fw-bold">Documents</h6>
            <p class="small text-muted mb-2">
              Click on text to view full text information
            </p>
            <input type="text" id="filteredSearchInput"
                   class="form-control form-control-sm mb-3"
                   placeholder="Search filtered documents..." />

            <div id="filteredTableWrapper" style="max-height: 500px; overflow-y: auto;">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead id="filteredTableHead"></thead>
                <tbody id="filteredTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary"
                  data-bs-dismiss="modal">Close</button>
        </div>

      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
  let POLL_TIMER = null;
  let POLL_ABORT = null;
  let COMPLETION_SHOWN = false;
  const DEBUG = true;

  const FALLBACK_STATUS_URL = "/status/";

  let allDocuments = [];
  let filteredDocs = [];

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const params  = new URLSearchParams(location.search);
      const corpusId = params.get("corpus_id");
      const jobId    = params.get("job_id");
      const modelId  = params.get("model_id");
      console.log("jobId:", jobId, "modelId:", modelId);

      if (!corpusId) {
        alert("Missing corpus_id.");
        return;
      }

      await loadVisualization(corpusId);
      wireUI();

      if (jobId) {
        startPolling(`/status/jobs/${encodeURIComponent(jobId)}`, 1000);
      } else {
        // Optional fallback if you ever land here without job_id
        // (callTrainingInfo would need to be implemented)
        // const { statusUrl } = await callTrainingInfo(corpusId);
        // if (statusUrl) startPolling(statusUrl, 1000);
      }
    } catch (err) {
      console.error("Error during initialization:", err);
      alert(err.message || "An error occurred during initialization.");
    }
  });

  async function loadVisualization(corpusId) {
    console.groupCollapsed("[viz] loadVisualization");
    try {
      const url = `/corpus/${encodeURIComponent(corpusId)}/tfidf/`;
      if (DEBUG) console.info("[viz] GET", url);
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`Failed to load TF-IDF: ${res.status} ${txt}`);
      }

      const jsonData = await res.json();
      if (DEBUG) console.info("[viz] TF-IDF data:", jsonData);

      const docs = Array.isArray(jsonData.documents) ? jsonData.documents : [];
      renderThemeVisualizations(docs);
      populateThemeDiagnosticsTable(jsonData.per_cluster || {});
      populateThemeInsights(jsonData.global || {});
      renderDocumentTable(docs);

      allDocuments = docs;
      populateThemeFilterOptions(allDocuments);
      filterAndRenderDocuments(allDocuments);
    } catch (err) {
      console.error("[viz] Error:", err);
      alert("Could not load visualization results.");
    } finally {
      console.groupEnd();
    }
  }

  function wireUI() {
    document.getElementById("filterBtn")?.addEventListener("click", filterAndRenderDocuments);
    document.getElementById("docSearchInput")?.addEventListener("input", filterAndRenderDocuments);
    document.getElementById("filteredSearchInput")?.addEventListener("input", (e) => {
      filterAndRenderThemeDocuments(e);
    });

    const toggleMetricBtn    = document.getElementById("toggleMetricBtn");
    const themeMetricsPanel  = document.getElementById("themeMetricsPanel");
    const modelMetricsPanel  = document.getElementById("modelMetricsPanel");
    if (toggleMetricBtn && themeMetricsPanel && modelMetricsPanel) {
      toggleMetricBtn.addEventListener("click", () => {
        const showingTheme = !themeMetricsPanel.classList.contains("d-none");
        themeMetricsPanel.classList.toggle("d-none", showingTheme);
        modelMetricsPanel.classList.toggle("d-none", !showingTheme);
        toggleMetricBtn.textContent = showingTheme
          ? "Switch to Theme Metrics"
          : "Switch to Model Metrics";
      });
    }
  }

  function startPolling(statusUrl, intervalMs) {
    stopPolling();
    updateTrainingUI({ status: "starting" });
    scheduleNextPoll(statusUrl, intervalMs);
  }

  function stopPolling() {
    if (POLL_TIMER) clearTimeout(POLL_TIMER);
    POLL_TIMER = null;
    if (POLL_ABORT) POLL_ABORT.abort();
    POLL_ABORT = null;
  }

  function scheduleNextPoll(statusUrl, intervalMs) {
    if (POLL_TIMER) clearTimeout(POLL_TIMER);
    POLL_TIMER = setTimeout(() => pollOnce(statusUrl, intervalMs), intervalMs);
  }

  async function pollOnce(statusUrl, intervalMs) {
    try {
      POLL_ABORT = new AbortController();
      const response = await fetch(statusUrl, { cache: "no-store", signal: POLL_ABORT.signal });
      if (!response.ok) {
        const isTransient = [429, 500, 502, 503, 504].includes(response.status);
        if (isTransient) {
          scheduleNextPoll(statusUrl, Math.min(intervalMs * 2, 10000));
          return;
        }
        throw new Error(`Status fetch failed: ${response.status}`);
      }

      const data = await response.json().catch(() => ({}));
      const { done, error, progress } = data || {};

      updateTrainingUI(data);

      const finishedStatuses = new Set(["succeeded", "completed", "finished", "success"]);
      const isFinished =
        !!done ||
        (typeof progress === "number" && progress >= 1) ||
        (data.status && finishedStatuses.has(String(data.status).toLowerCase()));

      if (error || isFinished) {
        stopPolling();
        if (isFinished && !COMPLETION_SHOWN) {
          COMPLETION_SHOWN = true;
          await handleTrainingCompletion();
        }
        return;
      }

      scheduleNextPoll(statusUrl, intervalMs);
    } catch (err) {
      if (err.name === "AbortError") return;
      console.error("[training] polling error:", err);
      updateTrainingUI({ error: "Error connecting to training service." });
      scheduleNextPoll(statusUrl, 5000);
    }
  }

  function updateTrainingUI(data = {}) {
    const trainingEl  = document.getElementById("trainingMessage");
    const etaEl       = document.getElementById("etaText");
    const activityEl  = document.getElementById("activityLine");
    const btnWrap     = document.getElementById("redirectButtonContainer");
    const goBtn       = document.getElementById("goToModelBtn");
    const detBar      = document.getElementById("trainingBar");
    const indBar      = document.getElementById("indeterminateBar");
    const dot         = document.getElementById("trainingDot");

    if (!trainingEl || !etaEl || !activityEl) return;

    const {
      status, phase, progress, eta_seconds, queued_position,
      message, done, error
    } = data;

    let pct = null;
    if (typeof progress === "number" && !Number.isNaN(progress)) {
      pct = progress <= 1 ? Math.round(progress * 100) : Math.round(progress);
      pct = Math.max(0, Math.min(100, pct));
    }

    let mainText = "Initializing training‚Ä¶";
    if (error) mainText = `Error: ${String(error)}`;
    else if (done) mainText = "Training complete!";
    else if (status === "queued") {
      mainText = `Queued${Number.isFinite(queued_position) ? ` (position ${queued_position})` : ""}‚Ä¶`;
    } else if (status === "running" || status === "starting") {
      mainText = `Training${phase ? ` ‚Äî ${phase}` : ""}‚Ä¶${pct !== null ? ` ${pct}%` : ""}`;
    } else if (status) {
      mainText = `${status.charAt(0).toUpperCase() + status.slice(1)}‚Ä¶${pct !== null ? ` ${pct}%` : ""}`;
    } else if (message) {
      mainText = message;
    }
    trainingEl.textContent = mainText;

    let etaText = "";
    if (error) etaText = "‚Äî";
    else if (done) etaText = "Completed";
    else if (Number.isFinite(eta_seconds) && eta_seconds >= 0) {
      etaText = `ETA ‚Äî ~${formatETA(eta_seconds)}`;
    } else if (status === "queued" && Number.isFinite(queued_position)) {
      etaText = "Waiting for capacity‚Ä¶";
    }
    etaEl.textContent = etaText;

    if (error)       activityEl.textContent = "An error occurred. Check logs for details.";
    else if (done)   activityEl.textContent = "Finalizing artifacts‚Ä¶";
    else if (phase)  activityEl.textContent = `Current activity: ${phase}`;
    else if (message)activityEl.textContent = String(message);
    else if (status) activityEl.textContent = `Status: ${status}`;
    else             activityEl.textContent = "Working‚Ä¶";

    const setProgress = ({ percent = null, running = true } = {}) => {
      if (!detBar || !indBar) return;
      if (!running) {
        detBar.style.display = "none";
        indBar.style.display = "none";
        return;
      }
      if (percent === null) {
        detBar.style.display = "none";
        indBar.style.display = "block";
      } else {
        indBar.style.display = "none";
        detBar.style.display = "block";
        detBar.style.width = `${percent}%`;
        detBar.textContent = `${percent}%`;
        detBar.classList.toggle("bg-success", percent === 100);
      }
    };

    const setDotState = (mode) => {
      if (!dot) return;
      dot.classList.remove("done", "error");
      if (mode === "done") dot.classList.add("done");
      if (mode === "err")  dot.classList.add("error");
    };

    const finishedStatuses = new Set(["succeeded", "completed", "finished", "success"]);
    const isComplete =
      !!done ||
      (status && finishedStatuses.has(String(status).toLowerCase())) ||
      (pct !== null && pct >= 100);

    if (error) {
      setDotState("err");
      setProgress({ percent: null, running: false });
    } else if (isComplete) {
      setDotState("done");
      setProgress({ percent: 100, running: true });
    } else {
      setDotState("run");
      setProgress({ percent: pct, running: true });
    }

    if (btnWrap) {
      if (isComplete && !error) {
        btnWrap.style.display = "";
        btnWrap.classList.remove("d-none", "invisible");
        if (goBtn && !goBtn.dataset.bound) {
          goBtn.addEventListener("click", () => {
            window.location.href = "/trained-models";
          });
          goBtn.dataset.bound = "1";
        }
      } else {
        btnWrap.style.display = "none";
      }
    }
  }

  function formatETA(sec) {
    sec = Math.max(0, Math.floor(Number(sec) || 0));
    if (sec < 60) return `${sec}s`;
    const m = Math.floor(sec / 60), s = sec % 60;
    if (m < 60) return `${m}m ${s}s`;
    const h = Math.floor(m / 60), mm = m % 60;
    return `${h}h ${mm}m`;
  }

  function renderThemeVisualizations(docs) {
    const clusterCounts = {};
    const clusterColors = {};
    docs.forEach(doc => {
      const c = doc.cluster;
      clusterCounts[c] = (clusterCounts[c] || 0) + 1;
      if (!clusterColors[c]) {
        clusterColors[c] = `hsl(${(c * 50) % 360}, 70%, 60%)`;
      }
    });

    const sortedClusters = Object.keys(clusterCounts)
      .sort((a, b) => clusterCounts[b] - clusterCounts[a]);
    const barLabels = sortedClusters.map(c => `Cluster ${c}`);
    const barCounts = sortedClusters.map(c => clusterCounts[c]);
    const barColors = sortedClusters.map(c => clusterColors[c]);

    const themeCanvas = document.getElementById("themeChart");
    themeCanvas.hidden = false;
    if (window.themeChartInstance) window.themeChartInstance.destroy();

    const themeCtx = themeCanvas.getContext("2d");
    window.themeChartInstance = new Chart(themeCtx, {
      type: "bar",
      data: {
        labels: barLabels,
        datasets: [{
          label: "Documents per Cluster",
          data: barCounts,
          backgroundColor: barColors
        }]
      },
      options: {
        responsive: true,
        onClick: (event, elements) => {
          if (elements.length > 0) {
            const index       = elements[0].index;
            const clusterId   = sortedClusters[index];
            const clusterColor = clusterColors[clusterId];
            showThemeDetailModal(clusterId, docs, clusterColor);
          }
        },
        plugins: {
          title: { display: true, text: "Theme Overview", font: { size: 16 } },
          legend: { display: false }
        },
        scales: {
          x: { title: { display: true, text: "Cluster" } },
          y: { beginAtZero: true, title: { display: true, text: "Document Count" } }
        }
      }
    });
  }

  function showTextModal(doc) {
    document.getElementById("modalClusterTitle").textContent =
      `Cluster ${doc.cluster ?? "‚Äì"}`;
    document.getElementById("modalFullText").textContent =
      doc.text || "(No text provided)";

    const kwContainer = document.getElementById("modalKeywords");
    kwContainer.innerHTML = "";
    (doc.keywords || []).forEach(kw => {
      const badge = document.createElement("span");
      badge.className = "badge bg-secondary";
      badge.textContent = kw;
      kwContainer.appendChild(badge);
    });

    new bootstrap.Modal(document.getElementById("docDetailModal")).show();
  }

  function renderFilteredTable(docs = []) {
    const thead = document.getElementById("filteredTableHead");
    const tbody = document.getElementById("filteredTableBody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (docs.length === 0) {
      thead.innerHTML = `<tr><th>No data</th></tr>`;
      tbody.innerHTML = `<tr><td class="text-muted">No documents to display.</td></tr>`;
      return;
    }

    const columns = ["id", "text", "score"];
    const widths  = { id: "10%", text: "70%", score: "20%" };
    docs.sort((a, b) => (b.score || 0) - (a.score || 0));

    const headerRow = document.createElement("tr");
    columns.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col.charAt(0).toUpperCase() + col.slice(1);
      th.classList.add("small-text", "text-nowrap");
      th.style.width = widths[col];
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    docs.forEach(doc => {
      const row = document.createElement("tr");
      columns.forEach(col => {
        const td = document.createElement("td");
        td.style.width = widths[col];
        td.classList.add("small-text");

        if (col === "text") {
          const fullText = doc.text || "";
          const offset   = Math.floor(fullText.length / 40);
          const tail     = fullText.slice(offset);
          const match    = tail.match(/\b\w[^\s]{5,}/);
          const startIdx = match ? tail.indexOf(match[0]) : 0;
          const snippet  = tail.slice(startIdx, startIdx + 100).trim()
                           + (fullText.length > offset + 100 ? "‚Ä¶" : "");
          td.textContent = snippet;
          td.classList.add("truncate-cell", "text-primary");
          td.title = "Click to view full text";
          td.style.cursor = "pointer";
          td.addEventListener("click", e => {
            e.stopPropagation();
            showTextModal(doc);
          });
        } else if (col === "score" && typeof doc.score === "number") {
          td.textContent = doc.score.toFixed(3);
        } else if (col === "id") {
          const fullId  = doc.id != null ? String(doc.id) : "";
          const shortId = fullId ? fullId.slice(0, 5) : "‚Äî";
          td.textContent = shortId;
          if (fullId) td.title = fullId;
        } else {
          td.textContent = doc[col] ?? "‚Äî";
        }

        row.appendChild(td);
      });
      tbody.appendChild(row);
    });
  }

  function showThemeDetailModal(clusterId, docs, color = "#ccc") {
    const clusterDocs = docs.filter(d => d.cluster == clusterId);
    const modal       = document.getElementById("themeDetailModal");
    modal.querySelector("#selectedThemeLabel").textContent = `Theme ${clusterId}`;
    modal.querySelector(".modal-content")
         .style.setProperty("--theme-color", color);
    document.getElementById("keywordsBox").style.borderColor = color;
    document.getElementById("docsBox").style.borderColor     = color;

    const keywordBox = document.getElementById("selectedThemeKeywords");
    keywordBox.innerHTML = "";
    const keywords = clusterDocs[0]?.keywords || [];
    keywords.forEach(kw => {
      const span = document.createElement("span");
      span.className = "badge bg-secondary";
      span.textContent = kw;
      keywordBox.appendChild(span);
    });

    filteredDocs = clusterDocs;
    renderFilteredTable(clusterDocs);

    new bootstrap.Modal(modal).show();
  }

  function populateThemeDiagnosticsTable(perCluster = {}) {
    const tableHead = document.querySelector("#themeStatsTable thead");
    const tableBody = document.querySelector("#themeStatsTable tbody");
    if (!tableHead || !tableBody) {
      console.error("Theme diagnostics table elements not found");
      return;
    }

    tableHead.innerHTML = "";
    tableBody.innerHTML = "";

    const clusterKeys = Object.keys(perCluster);
    if (clusterKeys.length === 0) {
      tableHead.innerHTML = `<tr><th>No Data</th></tr>`;
      tableBody.innerHTML = `<tr><td class="text-muted">No diagnostics available.</td></tr>`;
      return;
    }

    const metrics = Object.keys(perCluster[clusterKeys[0]]);
    const columns = ["Cluster", ...metrics];

    const headerRow = document.createElement("tr");
    columns.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col.replace(/_/g, " ")
                          .replace(/\b\w/g, l => l.toUpperCase());
      th.classList.add("small-text", "text-nowrap");
      headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    clusterKeys.forEach(clusterId => {
      const row = document.createElement("tr");
      const clusterData = perCluster[clusterId];
      columns.forEach(col => {
        const td = document.createElement("td");
        td.classList.add("small-text");
        if (col === "Cluster") {
          td.textContent = clusterId;
        } else {
          const val = clusterData[col];
          td.textContent =
            typeof val === "number"
              ? (col.toLowerCase().includes("prevalence") ? `${val}` : val.toFixed(3))
              : (val ?? "‚Äî");
        }
        row.appendChild(td);
      });
      tableBody.appendChild(row);
    });
  }

  function populateThemeInsights(metrics = {}) {
    const container = document.getElementById("themeInsightsGrid");
    if (!container) return;
    container.innerHTML = "";

    const items = [
      { label: "Average Coherence (NPMI)", value: metrics.average_coherence },
      { label: "Average Entropy",          value: metrics.average_entropy },
      { label: "Topic Diversity",          value: metrics.topic_diversity },
      { label: "IRBO (Balance)",           value: metrics.irbo }
    ];

    items.forEach(metric => {
      const col = document.createElement("div");
      col.className = "col-md-6";
      col.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-3 rounded bg-light shadow-sm h-100">
          <div class="text-muted small fw-semibold">${metric.label}</div>
          <div class="fw-bold text-dark small">
            ${typeof metric.value === "number" ? metric.value.toFixed(3)
              : metric.value ?? "‚Äî"}
          </div>
        </div>
      `;
      container.appendChild(col);
    });
  }

  function filterAndRenderDocuments() {
    const searchTerm    = (document.getElementById("docSearchInput")?.value || "").toLowerCase();
    const selectedTheme = document.getElementById("themeFilter")?.value || "";
    const minScore      = parseFloat(document.getElementById("scoreMin")?.value || "");
    const maxScore      = parseFloat(document.getElementById("scoreMax")?.value || "");

    const filtered = allDocuments.filter(doc => {
      const matchesText  = !searchTerm || (doc.text || "").toLowerCase().includes(searchTerm);
      const matchesTheme = !selectedTheme || String(doc.cluster) === selectedTheme;
      const matchesMin   = isNaN(minScore) || (doc.score ?? -Infinity) >= minScore;
      const matchesMax   = isNaN(maxScore) || (doc.score ?? Infinity) <= maxScore;
      return matchesText && matchesTheme && matchesMin && matchesMax;
    });

    renderDocumentTable(filtered);
  }

  function populateThemeFilterOptions(docs) {
    const themeFilter = document.getElementById("themeFilter");
    if (!themeFilter) return;
    const uniqueClusters = [...new Set(docs.map(d => d.cluster))]
      .sort((a, b) => a - b);
    themeFilter.innerHTML = `<option value="">All Themes</option>`;
    uniqueClusters.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = `${c}`;
      themeFilter.appendChild(opt);
    });
  }

  function renderDocumentTable(docs = []) {
    const thead = document.getElementById("docTableHead");
    const tbody = document.getElementById("docTableBody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (docs.length === 0) {
      thead.innerHTML = `<tr><th>No data</th></tr>`;
      tbody.innerHTML = `<tr><td class="text-muted">No documents to display.</td></tr>`;
      return;
    }

    const columns = ["id", "text", "cluster", "score"];
    const widths  = { id: "10%", text: "70%", cluster: "10%", score: "10%" };

    const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const findStartIndexFromStartWord = (fullText, startWord) => {
      if (!startWord) return -1;
      const pattern = new RegExp(`\\b${escapeRegExp(startWord)}\\b`, "i");
      const match   = fullText.match(pattern);
      return match ? match.index : -1;
    };
    const makeSnippet = (fullText, startIdx, maxLen = 80) => {
      if (startIdx < 0 || startIdx >= fullText.length) startIdx = 0;
      let snippet = fullText.slice(startIdx, startIdx + maxLen).trim();
      if (fullText.length > startIdx + maxLen) snippet += "‚Ä¶";
      return snippet;
    };

    const headerRow = document.createElement("tr");
    columns.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col.charAt(0).toUpperCase() + col.slice(1);
      th.classList.add("small-text", "align-middle", "text-nowrap");
      th.style.width = widths[col] || "auto";
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    docs.sort((a, b) =>
      (a.cluster !== b.cluster ? a.cluster - b.cluster : (b.score || 0) - (a.score || 0))
    );

    docs.forEach(doc => {
      const row = document.createElement("tr");
      columns.forEach(col => {
        const td = document.createElement("td");
        td.classList.add("small-text", "align-middle", "truncate-cell");
        td.style.width = widths[col] || "auto";

        if (col === "text") {
          const fullText = doc.text || "";
          let startIdx = findStartIndexFromStartWord(fullText, doc.start_word);
          if (startIdx === -1) {
            const offset = Math.floor(fullText.length / 40);
            const tail   = fullText.slice(offset);
            const match  = tail.match(/\b\w[^\s]{10,}/);
            const localIdx = match ? tail.indexOf(match[0]) : 0;
            startIdx = offset + localIdx;
          }
          const snippet = makeSnippet(fullText, startIdx, 80);
          td.textContent = snippet;
          td.classList.add("text-primary");
          td.style.cursor = "pointer";
          td.title = "Click to view full text";
          td.addEventListener("click", (e) => {
            e.stopPropagation();
            showTextModal(doc);
          });
        } else if (col === "score" && typeof doc.score === "number") {
          td.textContent = doc.score.toFixed(3);
        } else if (col === "id") {
          const fullId  = doc.id != null ? String(doc.id) : "";
          const shortId = fullId ? fullId.slice(0, 5) : "‚Äî";
          td.textContent = shortId;
          if (fullId) td.title = fullId;
        } else {
          td.textContent = doc[col] !== undefined ? doc[col] : "‚Äî";
        }

        row.appendChild(td);
      });
      tbody.appendChild(row);
    });
  }

  function filterAndRenderThemeDocuments(e) {
    const term = (e.target.value || "").trim().toLowerCase();
    const filtered = filteredDocs.filter(doc =>
      (doc.text || "").toLowerCase().includes(term)
    );
    renderFilteredTable(filtered);
  }

  async function handleTrainingCompletion() {
    try {
      const params   = new URLSearchParams(location.search);
      const corpusId = params.get("corpus_id");
      const modelId  = params.get("model_id");

      if (corpusId && modelId) {
        const addModelUrl = `/data/corpus/add_model`;
        console.log("[training] Calling add_model endpoint:", addModelUrl);

        const response = await fetch(addModelUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ corpus_id: corpusId, model_id: modelId }),
          cache: "no-store"
        });

        if (response.ok) {
          const result = await response.json();
          console.log("[training] Successfully added model to corpus:", result);
        } else {
          console.warn("[training] Failed to add model to corpus:",
                       response.status, response.statusText);
        }
      } else {
        console.warn("[training] Missing corpus_id or model_id, skipping add_model call",
                     { corpusId, modelId });
      }
    } catch (error) {
      console.error("[training] Error calling add_model endpoint:", error);
    } finally {
      showTrainingCompleteModal();
    }
  }

  function showTrainingCompleteModal() {
    const modalEl = document.getElementById("trainingCompleteModal");
    if (!modalEl) return;
    const modal = new bootstrap.Modal(modalEl, { backdrop: "static", keyboard: true });
    modal.show();

    const btn = document.getElementById("viewModelsBtn");
    if (btn && !btn.dataset.bound) {
      btn.addEventListener("click", () => {
        modal.hide();
        window.location.href = "/trained-models";
      });
      btn.dataset.bound = "1";
    }
  }
</script>
{% endblock %}

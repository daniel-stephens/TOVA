{% extends "base.html" %}
{% block title %}Trained Models - TOVA{% endblock %}

{% block extra_head %}
<style>
  body { background: radial-gradient(circle at 10% 20%, rgba(13,110,253,0.06), transparent 25%), #f7f9fb; }
  .kv-row {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 0.35rem 0.75rem;
    font-size: 0.875rem;
    margin-bottom: 0.15rem;
  }
  .kv-row .k { color: #6c757d; }
  .kv-row .v { color: #212529; word-break: break-word; }
  .model-card {
    border: 1px solid #e7ebf0;
    transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
  }
  .model-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    border-color: #d0d7e2;
  }
  .model-card .badge { font-weight: 600; }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: #f1f5f9;
    color: #475569;
    font-size: 0.85rem;
    border: 1px solid #e2e8f0;
  }
  .summary-card {
    border: 1px solid #e7ebf0;
    background: linear-gradient(135deg, #ffffff, #f6f9fc);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-sm py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
    <div>
      <h3 class="mb-1">Trained Models</h3>
      <p class="text-muted small mb-0">Models you’ve trained, grouped by corpus.</p>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <span class="pill"><i class="bi bi-diagram-3"></i> <span id="corpusCount">0</span> corpora</span>
        <span class="pill"><i class="bi bi-cpu"></i> <span id="modelCount">0</span> models</span>
      </div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary btn-sm" onclick="history.back()">
        <i class="bi bi-arrow-left"></i> Back
      </button>
      <a class="btn btn-primary btn-sm" href="{{ url_for('loadModel') }}">
        <i class="bi bi-plus-lg"></i> Train new model
      </a>
    </div>
  </div>

  <div class="container-sm my-4 p-4 bg-white rounded shadow-sm border border-light-subtle">
    <div class="row g-3 align-items-center mb-3">
      <div class="col-sm-6 col-lg-4">
        <label for="modelSearch" class="form-label small text-muted mb-1">Search</label>
        <input id="modelSearch" type="search" class="form-control form-control-sm" placeholder="Filter by name, corpus, owner">
      </div>
      <div class="col-sm-6 col-lg-3">
        <label for="corpusFilter" class="form-label small text-muted mb-1">Corpus</label>
        <select id="corpusFilter" class="form-select form-select-sm">
          <option value="">All corpora</option>
        </select>
      </div>
    </div>

    <div id="modelsSpinner" class="d-flex justify-content-center py-4">
      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div id="modelsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 d-none"></div>

    <div id="noModels" class="alert alert-warning text-center mt-5 d-none">
      No trained models found.
      <div class="mt-2">
        <a class="btn btn-sm btn-primary" href="{{ url_for('loadModel') }}">Train a model</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
  const grid         = document.getElementById("modelsGrid");
  const spinner      = document.getElementById("modelsSpinner");
  const noModels     = document.getElementById("noModels");
  const searchInput  = document.getElementById("modelSearch");
  const corpusFilter = document.getElementById("corpusFilter");

  let allModels = [];

  const escapeHtml = (str) =>
    String(str ?? "").replace(/[&<>\"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  function prettyModelType(typeStr) {
    const last = String(typeStr || "").split(".").pop() || "";
    return last.replace(/TMmodel$/i,"").replace(/Model$/i,"") || "—";
  }
  function fmtDate(isoStr) {
    if (!isoStr) return "—";
    const d = new Date(isoStr);
    return isNaN(d) ? escapeHtml(isoStr) : d.toLocaleString();
  }

  function normalizeCorporaToModels(corpora) {
    const out = [];
    (corpora || []).forEach((c) => {
      const corpusId   = c?.id || c?.metadata?.id || "";
      const corpusName = c?.name || c?.metadata?.name || "";
      const corpusLoc  = c?.location || c?.metadata?.location || "";
      const corpusCreated = c?.created_at || c?.metadata?.created_at || "";

      (c?.models || []).forEach((m) => {
        const md = m?.metadata || {};
        const tr = md?.tr_params || {};
        out.push({
          id: m?.id || tr?.id || "",
          name: m?.name || md?.name || tr?.model_name || "",
          owner_id: m?.owner_id ?? md?.owner_id ?? null,
          location: m?.location || md?.location || "",
          created_at: m?.created_at || md?.created_at || "",
          metadata: m?.metadata || {},
          __corpus: {
            id: corpusId,
            name: corpusName,
            location: corpusLoc,
            created_at: corpusCreated
          },
        });
      });
    });
    return out;
  }

  function renderCard(m) {
    const corpus = m.__corpus || {};
    const meta = m.metadata || {};
    const tr = meta.tr_params || {};
    const dataset = meta.dataset || {};
    const provider = tr.llm_provider || meta.llm_provider || "—";
    const modelType = prettyModelType(tr.model || tr.training_model || meta.model || m.name);
    const host = tr.llm_host || meta.llm_host || "—";

    const datasetInfo = dataset.name || dataset.id;

    const paramsHtml = `
      <div class="kv-row"><div class="k">Num topics</div><div class="v">${escapeHtml(tr.num_topics ?? "—")}</div></div>
      <div class="kv-row"><div class="k">Top N</div><div class="v">${escapeHtml(tr.topn ?? "—")}</div></div>
      <div class="kv-row"><div class="k">Theta thr</div><div class="v">${escapeHtml(tr.thetas_thr ?? "—")}</div></div>
    `;

    const metricsHtml = meta.metrics
      ? `<div class="kv-row"><div class="k">Metrics</div><div class="v"><pre class="mb-0 small">${escapeHtml(JSON.stringify(meta.metrics, null, 2))}</pre></div></div>`
      : "";

    return `
      <div class="col">
        <div class="card h-100 shadow-sm border-0 border-top rounded-3 model-card" data-model-id="${escapeHtml(m.id)}" data-model-name="${escapeHtml(m.name || "(unnamed)")}">
          <div class="card-body d-flex flex-column justify-content-between">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title mb-1 text-break">${escapeHtml(m.name || "(unnamed)")}</h5>
                <p class="text-muted small mb-2">${escapeHtml(modelType)}</p>
              </div>
              <span class="badge text-bg-light">${escapeHtml(corpus.name || "Corpus")}</span>
            </div>
            <div class="kv-row"><div class="k">Model ID</div><div class="v">${escapeHtml(m.id)}</div></div>
            <div class="kv-row"><div class="k">Owner</div><div class="v">${escapeHtml(m.owner_id || "—")}</div></div>
            <div class="kv-row"><div class="k">LLM</div><div class="v">${escapeHtml(provider)}</div></div>
            <div class="kv-row"><div class="k">Host</div><div class="v">${escapeHtml(host)}</div></div>
            <div class="kv-row"><div class="k">Created</div><div class="v">${escapeHtml(fmtDate(m.created_at))}</div></div>
            ${datasetInfo ? `<div class="kv-row"><div class="k">Dataset</div><div class="v">${escapeHtml(datasetInfo)}</div></div>` : ""}
            ${paramsHtml}
            ${metricsHtml}
            <div class="d-flex justify-content-between align-items-center mt-3">
              <button class="btn btn-primary btn-sm use-model-btn" data-model-id="${escapeHtml(m.id)}">
                Open Dashboard
              </button>
              <button class="btn btn-outline-danger btn-sm delete-model" data-model-id="${escapeHtml(m.id)}" data-model-name="${escapeHtml(m.name || "")}">
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function applyFilters() {
    const term = (searchInput?.value || "").toLowerCase();
    const corpusId = corpusFilter?.value || "";
    const filtered = allModels.filter((m) => {
      const corpusName = (m.__corpus?.name || "").toLowerCase();
      const matchTerm =
        !term ||
        (m.name || "").toLowerCase().includes(term) ||
        (m.owner_id || "").toLowerCase().includes(term) ||
        corpusName.includes(term);
      const matchCorpus = !corpusId || m.__corpus?.id === corpusId;
      return matchTerm && matchCorpus;
    });

    if (!filtered.length) {
      grid.classList.add("d-none");
      noModels.classList.remove("d-none");
      grid.innerHTML = ""; // Clear grid when no models
      return;
    }
    noModels.classList.add("d-none");
    grid.classList.remove("d-none");
    grid.innerHTML = filtered.map(renderCard).join("");
    wireActions();
  }

  async function loadModels() {
    try {
      const res = await fetch("/get-trained-models", { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load: ${res.status}`);
      const corpora = await res.json();
      allModels = normalizeCorporaToModels(Array.isArray(corpora) ? corpora : []);

      spinner.classList.add("d-none");
      if (!allModels.length) {
        noModels.classList.remove("d-none");
        return;
      }

      const corpusOptions = Array.from(
        new Set(allModels.map((m) => m.__corpus?.id).filter(Boolean))
      ).map((id) => {
        const name = allModels.find((m) => m.__corpus?.id === id)?.__corpus?.name || id;
        return { id, name };
      });

      if (corpusFilter) {
        corpusFilter.innerHTML = `<option value="">All corpora</option>` +
          corpusOptions.map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");
      }

      applyFilters();
    } catch (err) {
      console.error(err);
      spinner.classList.add("d-none");
      noModels.textContent = "Failed to load models.";
      noModels.classList.remove("d-none");
    }
  }

  // Use event delegation - attach once to grid, works for all buttons
  let actionsWired = false;
  function wireActions() {
    if (actionsWired) return; // Only wire once using event delegation
    actionsWired = true;
    
    grid.addEventListener("click", (e) => {
      const useBtn = e.target.closest(".use-model-btn");
      if (useBtn) {
        e.preventDefault();
        const modelId = useBtn.dataset.modelId;
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/dashboard";
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "model_id";
        input.value = modelId;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
        return;
      }
      
      const deleteBtn = e.target.closest(".delete-model");
      if (deleteBtn) {
        e.preventDefault();
        const modelId = deleteBtn.dataset.modelId;
        const modelName = deleteBtn.dataset.modelName || modelId;
        if (!confirm(`Delete model "${modelName}"?`)) return;
        
        (async () => {
          // Immediately fade out the model card for instant feedback
          const card = deleteBtn.closest(".model-card");
          const cardParent = card?.parentElement;
          if (card) {
            card.style.transition = "opacity 0.3s";
            card.style.opacity = "0.3";
            card.style.pointerEvents = "none";
          }
          
          try {
            const res = await fetch("/delete-model", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ model_id: modelId, model_name: modelName }),
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data?.message || `Delete failed (${res.status})`);
            
            // Remove card immediately from DOM
            if (cardParent) {
              cardParent.remove();
            }
            
            // Refresh the full list
            spinner.classList.remove("d-none");
            grid.classList.add("d-none");
            await loadModels();
          } catch (err) {
            console.error(err);
            alert("Failed to delete model.");
            // Restore card on error
            if (card) {
              card.style.opacity = "1";
              card.style.pointerEvents = "auto";
            }
            spinner.classList.add("d-none");
          }
        })();
        return;
      }
    });
  }

  searchInput?.addEventListener("input", applyFilters);
  corpusFilter?.addEventListener("change", applyFilters);
  loadModels();
})();
</script>
{% endblock %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trained Models - TOVA</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
      body { background-color: #f8f9fa; }
      .popover { max-width: 420px; }
      .kv-row {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 0.35rem 0.75rem;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }
      .kv-row .k { color: #6c757d; }
      .kv-row .v { color: #212529; word-break: break-word; }
    </style>
  </head>

  <body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">TOVA</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-between" id="navbarContent">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link{% if request.path == '/' %} active{% endif %}" href="/">Home</a></li>
            <li class="nav-item"><a class="nav-link{% if 'load' in request.path %} active{% endif %}" href="/model">Train Models</a></li>
            <li class="nav-item"><a class="nav-link{% if 'train' in request.path %} active{% endif %}" href="/trained-models">View Models</a></li>
          </ul>
          <li class="nav-item">
            <button class="btn btn-sm btn-outline-secondary ms-3" onclick="history.back()">Back</button>
          </li>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <div class="container-sm py-4">
      <h3 class="mb-4 text-center">Trained Models</h3>

      <div class="container-sm my-4 p-4 bg-white rounded shadow-sm border border-light-subtle">
        <!-- spinner -->
        <div id="modelsSpinner" class="d-flex justify-content-center py-4">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- grid -->
        <div id="modelsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 d-none"></div>

        <!-- empty state -->
        <div id="noModels" class="alert alert-warning text-center mt-5 d-none">No trained models found.</div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      (function () {
        const grid    = document.getElementById("modelsGrid");
        const spinner = document.getElementById("modelsSpinner");
        const noModels= document.getElementById("noModels");

        // ========= Utils =========
        const escapeHtml = (str) =>
          String(str ?? "").replace(/[&<>\"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

        function prettyModelType(typeStr) {
          const last = String(typeStr || "").split(".").pop() || "";
          return last.replace(/TMmodel$/i,"").replace(/Model$/i,"") || "—";
        }
        function fmtDate(isoStr) {
          if (!isoStr) return "—";
          const d = new Date(isoStr);
          return isNaN(d) ? escapeHtml(isoStr) : d.toLocaleString();
        }
        function kvRow(label, value) {
          return `<div class="kv-row"><div class="k"><strong>${escapeHtml(label)}:</strong></div><div class="v">${escapeHtml(value == null ? "—" : String(value))}</div></div>`;
        }

        // ========= Normalization =========
        // API  returns: [{ id: c_..., name, metadata, models: [ { id: m_..., metadata: { tr_params... } } ] }, ...]
        function normalizeCorporaToModels(corpora) {
          const out = [];
          (corpora || []).forEach((c) => {
            const corpusId   = c?.id || c?.metadata?.id || "";
            const corpusName = c?.name || c?.metadata?.name || "";
            const corpusLoc  = c?.location || c?.metadata?.location || "";
            const corpusCreated = c?.created_at || c?.metadata?.created_at || "";

            (c?.models || []).forEach((m) => {
              // build a model object we render from, and embed corpus info
              const md = m?.metadata || {};
              const tr = md?.tr_params || {};
              out.push({
                // model fields
                id: m?.id || tr?.id || "",
                name: m?.name || md?.name || tr?.model_name || "",
                owner_id: m?.owner_id ?? md?.owner_id ?? null,
                location: m?.location || md?.location || "",
                created_at: m?.created_at || md?.created_at || "",
                metadata: m?.metadata || {},
                // attach corpus info for rendering
                __corpus: {
                  id: corpusId,
                  name: corpusName,
                  location: corpusLoc,
                  created_at: corpusCreated
                }
              });
            });
          });
          return out;
        }

        function getFields(model) {
          const md = model?.metadata || {};
          const tr = md?.tr_params || {};

          // model id MUST be m_*
          const id = (typeof model?.id === "string" && model.id.startsWith("m_"))
            ? model.id
            : (typeof tr?.id === "string" && tr.id.startsWith("m_")) ? tr.id : (model?.id || "");

          const name = md?.name || tr?.model_name || model?.name || id || "—";
          const typeFull   = md?.type || "";
          const typePretty = prettyModelType(typeFull);
          const numTopics  = (typeof tr?.num_topics === "number") ? tr.num_topics : "—";

          const corpusId   = tr?.corpus_id || model?.__corpus?.id || "";
          const corpusName = model?.__corpus?.name || md?.corpus_name || "";

          const location   = model?.location || md?.location || model?.__corpus?.location || "";
          const createdAt  = model?.created_at || md?.created_at || "";

          return { id, name, typeFull, typePretty, numTopics, corpusId, corpusName, location, createdAt, ownerId: model?.owner_id ?? "" };
        }

        function buildPopoverContent(model) {
          const f = getFields(model);
          const tr = model?.metadata?.tr_params || {};
          const lines = [
            kvRow("Name", f.name),
            kvRow("ID", f.id || "—"),
            kvRow("Type", f.typeFull ? `${f.typePretty} (${f.typeFull})` : f.typePretty),
            kvRow("Location", f.location || "—"),
            kvRow("Corpus ID", f.corpusId || "—"),
            kvRow("Corpus Name", f.corpusName || "—"),
            kvRow("Owner", f.ownerId || "—"),
            kvRow("Created", fmtDate(f.createdAt)),
            '<hr class="my-2">'
          ];
          Object.keys(tr).sort().forEach((k) => lines.push(kvRow(k, tr[k])));
          return `<div class="popover-body-inner">${lines.join("")}</div>`;
        }

        // ========= Data fetch =========
        async function fetchModels() {
          try {
            const res = await fetch("/get-trained-models", { cache: "no-store" });
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const corpora = await res.json();
            return normalizeCorporaToModels(Array.isArray(corpora) ? corpora : []);
          } catch (e) {
            console.error("Failed to load models:", e);
            return [];
          }
        }

        // ========= Rendering =========
        function renderCard(model) {
          const f = getFields(model);

          const col = document.createElement("div");
          col.className = "col d-flex";

          const card = document.createElement("div");
          card.className = "card shadow-sm position-relative w-100 h-100 model-card";
          card.style.border = "1px solid #e2e6ea";
          card.tabIndex = 0;
          card.__model = model;

          // delete icon
          const del = document.createElement("a");
          del.href = "#";
          del.className = "position-absolute top-0 end-0 m-2 text-danger delete-model";
          del.title = "Delete model";
          del.innerHTML = '<i class="bi bi-x-circle-fill fs-5"></i>';
          del.dataset.modelId = f.id;
          del.dataset.modelName = f.name;

          // body
          const body = document.createElement("div");
          body.className = "card-body d-flex flex-column justify-content-between";

          const top = document.createElement("div");
          top.className = "text-center";
          top.innerHTML = `
            <h4 class="fw-bold mb-1 text-break">${escapeHtml(f.name)}</h4>
            <div class="text-muted">
              Model Type: <span class="fw-semibold">${escapeHtml(f.typePretty)}</span>
            </div>
            <div class="text-muted">
              Number of topics: <span class="fw-semibold">${escapeHtml(String(f.numTopics))}</span>
            </div>
            <div class="text-muted">
              Corpus: <span class="fw-semibold">${escapeHtml(f.corpusName || f.corpusId || "—")}</span>
            </div>
            <div class="text-muted">
              Location: <span class="fw-semibold">${escapeHtml(f.location || "—")}</span>
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "mt-3";
          actions.innerHTML = `
            <button class="btn btn-primary btn-sm use-model-btn"
                    data-model-id="${escapeHtml(f.id)}"
                    data-model-name="${escapeHtml(f.name)}"
                    aria-label="Use model ${escapeHtml(f.name)}">
              Open Dashboard
            </button>
          `;

          body.appendChild(top);
          body.appendChild(actions);
          card.appendChild(del);
          card.appendChild(body);
          col.appendChild(card);
          return col;
        }

        function wireCardInteractions(scope) {
          // Delete
          scope.querySelectorAll(".delete-model").forEach((a) => {
            a.addEventListener("click", (ev) => {
              ev.preventDefault();
              const modelId = a.dataset.modelId;
              const modelName = a.dataset.modelName;
              deleteModel(modelId, modelName);
            });
          });

          // Open Dashboard (send model_id = m_…)
          scope.querySelectorAll(".use-model-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const modelId = btn.getAttribute("data-model-id");

              const form = document.createElement("form");
              form.method = "POST";
              form.action = `/dashboard`;

              const inputId = document.createElement("input");
              inputId.type = "hidden";
              inputId.name = "model_id";
              inputId.value = modelId;
              form.appendChild(inputId);

              document.body.appendChild(form);
              form.submit();
            });
          });
        }

        // Popovers
        function enablePopovers(scope) {
          const cards = scope.querySelectorAll(".model-card");
          cards.forEach((card) => {
            const existing = bootstrap.Popover.getInstance(card);
            if (existing) existing.dispose();
            new bootstrap.Popover(card, {
              container: "body",
              html: true,
              trigger: "hover focus",
              placement: "auto",
              boundary: "viewport",
              delay: { show: 150, hide: 100 },
              sanitize: false,
              content: () => buildPopoverContent(card.__model),
            });
          });
        }

        // Delete call
        window.deleteModel = function deleteModel(modelId, modelName) {
          if (!confirm("Are you sure you want to delete this model?")) return;
          fetch("/delete-model", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model_id: modelId, model_name: modelName }),
          })
          .then(async (res) => {
            const data = await res.json().catch(() => ({ message: "Delete completed." }));
            if (!res.ok) throw new Error(data?.message || res.statusText);
            alert(data?.message || "Model deleted.");
            location.reload();
          })
          .catch((err) => {
            console.error("Delete failed:", err);
            alert("Failed to delete model.");
          });
        };

        // ===== Main =====
        async function main() {
          const models = await fetchModels();
          spinner?.classList.add("d-none");

          if (!models.length) {
            noModels?.classList.remove("d-none");
            return;
          }

          grid?.classList.remove("d-none");

          const frag = document.createDocumentFragment();
          models.forEach((m) => frag.appendChild(renderCard(m)));
          grid?.appendChild(frag);

          wireCardInteractions(grid);
          enablePopovers(grid);

        console.log([...document.querySelectorAll('.use-model-btn')].map(b=>b.dataset.modelId));
        }

        main();
      })();
    </script>
  </body>
</html>

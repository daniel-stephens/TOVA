<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trained Models - TOVA</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
      body { background-color: #f8f9fa; }
      .popover { max-width: 420px; }
      .kv-row {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 0.35rem 0.75rem;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }
      .kv-row .k { color: #6c757d; }
      .kv-row .v { color: #212529; word-break: break-word; }
    </style>
  </head>

  <body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">TOVA</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-between" id="navbarContent">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link{% if request.path == '/' %} active{% endif %}" href="/">Home</a></li>
            <li class="nav-item"><a class="nav-link{% if 'load' in request.path %} active{% endif %}" href="/model">Train Models</a></li>
            <li class="nav-item"><a class="nav-link{% if 'train' in request.path %} active{% endif %}" href="/trained-models">View Models</a></li>
          </ul>
          <li class="nav-item">
            <button class="btn btn-sm btn-outline-secondary ms-3" onclick="history.back()">Back</button>
          </li>
        </div>
      </div>
    </nav>

    <!-- Main -->
    <div class="container-sm py-4">
      <h3 class="mb-4 text-center">Trained Models</h3>

      <div class="container-sm my-4 p-4 bg-white rounded shadow-sm border border-light-subtle">
        <!-- spinner -->
        <div id="modelsSpinner" class="d-flex justify-content-center py-4">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- grid -->
        <div id="modelsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 d-none"></div>

        <!-- empty state -->
        <div id="noModels" class="alert alert-warning text-center mt-5 d-none">No trained models found.</div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      (function () {
        const grid    = document.getElementById("modelsGrid");
        const spinner = document.getElementById("modelsSpinner");
        const noModels= document.getElementById("noModels");

        // ========= Utils =========
        const escapeHtml = (str) =>
          String(str ?? "").replace(/[&<>\"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

        function prettyModelType(typeStr) {
          const last = String(typeStr || "").split(".").pop() || "";
          return last.replace(/TMmodel$/i,"").replace(/Model$/i,"") || "—";
        }
        function fmtDate(isoStr) {
          if (!isoStr) return "—";
          const d = new Date(isoStr);
          return isNaN(d) ? escapeHtml(isoStr) : d.toLocaleString();
        }
        function kvRow(label, value) {
          return `<div class="kv-row"><div class="k"><strong>${escapeHtml(label)}:</strong></div><div class="v">${escapeHtml(value == null ? "—" : String(value))}</div></div>`;
        }

        // ========= Normalization =========
        // API  returns: [{ id: c_..., name, metadata, models: [ { id: m_..., metadata: { tr_params... } } ] }, ...]
        function normalizeCorporaToModels(corpora) {
          const out = [];
          (corpora || []).forEach((c) => {
            const corpusId   = c?.id || c?.metadata?.id || "";
            const corpusName = c?.name || c?.metadata?.name || "";
            const corpusLoc  = c?.location || c?.metadata?.location || "";
            const corpusCreated = c?.created_at || c?.metadata?.created_at || "";

            (c?.models || []).forEach((m) => {
              // build a model object we render from, and embed corpus info
              const md = m?.metadata || {};
              const tr = md?.tr_params || {};
              out.push({
                // model fields
                id: m?.id || tr?.id || "",
                name: m?.name || md?.name || tr?.model_name || "",
                owner_id: m?.owner_id ?? md?.owner_id ?? null,
                location: m?.location || md?.location || "",
                created_at: m?.created_at || md?.created_at || "",
                metadata: m?.metadata || {},
                // attach corpus info for rendering
                __corpus: {
                  id: corpusId,
                  name: corpusName,
                  location: corpusLoc,
                  created_at: corpusCreated
                }
              });
            });
          });
          return out;
        }

        function getFields(model) {
          const md = model?.metadata || {};
          const tr = md?.tr_params || {};

          // model id MUST be m_*
          const id = (typeof model?.id === "string" && model.id.startsWith("m_"))
            ? model.id
            : (typeof tr?.id === "string" && tr.id.startsWith("m_")) ? tr.id : (model?.id || "");

          const name = md?.name || tr?.model_name || model?.name || id || "—";
          const typeFull   = md?.type || "";
          const typePretty = prettyModelType(typeFull);
          const numTopics  = (typeof tr?.num_topics === "number") ? tr.num_topics : "—";

          const corpusId   = tr?.corpus_id || model?.__corpus?.id || "";
          const corpusName = model?.__corpus?.name || md?.corpus_name || "";

          const location   = model?.location || md?.location || model?.__corpus?.location || "";
          const createdAt  = model?.created_at || md?.created_at || "";

          return { id, name, typeFull, typePretty, numTopics, corpusId, corpusName, location, createdAt, ownerId: model?.owner_id ?? "" };
        }

        function buildPopoverContent(model) {
          const f = getFields(model);
          const tr = model?.metadata?.tr_params || {};
          const lines = [
            kvRow("Name", f.name),
            kvRow("ID", f.id || "—"),
            kvRow("Type", f.typeFull ? `${f.typePretty} (${f.typeFull})` : f.typePretty),
            kvRow("Location", f.location || "—"),
            kvRow("Corpus ID", f.corpusId || "—"),
            kvRow("Corpus Name", f.corpusName || "—"),
            kvRow("Owner", f.ownerId || "—"),
            kvRow("Created", fmtDate(f.createdAt)),
            '<hr class="my-2">'
          ];
          Object.keys(tr).sort().forEach((k) => lines.push(kvRow(k, tr[k])));
          return `<div class="popover-body-inner">${lines.join("")}</div>`;
        }

        // ========= Data fetch =========
        async function fetchModels() {
          try {
            const res = await fetch("/get-trained-models", { cache: "no-store" });
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            const corpora = await res.json();
            return normalizeCorporaToModels(Array.isArray(corpora) ? corpora : []);
          } catch (e) {
            console.error("Failed to load models:", e);
            return [];
          }
        }

        // ========= Rendering =========
        function renderCard(model) {
          const f = getFields(model);

          const col = document.createElement("div");
          col.className = "col d-flex";

          const card = document.createElement("div");
          card.className = "card shadow-sm position-relative w-100 h-100 model-card";
          card.style.border = "1px solid #e2e6ea";
          card.tabIndex = 0;
          card.__model = model;

          // delete icon
          const del = document.createElement("a");
          del.href = "#";
          del.className = "position-absolute top-0 end-0 m-2 text-danger delete-model";
          del.title = "Delete model";
          del.innerHTML = '<i class="bi bi-x-circle-fill fs-5"></i>';
          del.dataset.modelId = f.id;
          del.dataset.modelName = f.name;

          // body
          const body = document.createElement("div");
          body.className = "card-body d-flex flex-column justify-content-between";

          const top = document.createElement("div");
          top.className = "text-center";
          top.innerHTML = `
            <h4 class="fw-bold mb-1 text-break">${escapeHtml(f.name)}</h4>
            <div class="text-muted">
              Model Type: <span class="fw-semibold">${escapeHtml(f.typePretty)}</span>
            </div>
            <div class="text-muted">
              Number of topics: <span class="fw-semibold">${escapeHtml(String(f.numTopics))}</span>
            </div>
            <div class="text-muted">
              Corpus: <span class="fw-semibold">${escapeHtml(f.corpusName || f.corpusId || "—")}</span>
            </div>
            <div class="text-muted">
              Location: <span class="fw-semibold">${escapeHtml(f.location || "—")}</span>
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "mt-3";
          actions.innerHTML = `
            <button class="btn btn-primary btn-sm use-model-btn"
                    data-model-id="${escapeHtml(f.id)}"
                    data-model-name="${escapeHtml(f.name)}"
                    aria-label="Use model ${escapeHtml(f.name)}">
              Open Dashboard
            </button>
          `;

          body.appendChild(top);
          body.appendChild(actions);
          card.appendChild(del);
          card.appendChild(body);
          col.appendChild(card);
          return col;
        }

        function wireCardInteractions(scope) {
          // Delete
          scope.querySelectorAll(".delete-model").forEach((a) => {
            a.addEventListener("click", (ev) => {
              ev.preventDefault();
              const modelId = a.dataset.modelId;
              const modelName = a.dataset.modelName;
              deleteModel(modelId, modelName);
            });
          });

          // Open Dashboard (send model_id = m_…)
          scope.querySelectorAll(".use-model-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const modelId = btn.getAttribute("data-model-id");

              const form = document.createElement("form");
              form.method = "POST";
              //form.action = `/dashboard/${encodeURIComponent(modelId)}`;
              form.action = `/dashboard`;

              const inputId = document.createElement("input");
              inputId.type = "hidden";
              inputId.name = "model_id";
              inputId.value = modelId;
              form.appendChild(inputId);

              document.body.appendChild(form);
              form.submit();
            });
          });
        }

        // Popovers
        function enablePopovers(scope) {
          const cards = scope.querySelectorAll(".model-card");
          cards.forEach((card) => {
            const existing = bootstrap.Popover.getInstance(card);
            if (existing) existing.dispose();
            new bootstrap.Popover(card, {
              container: "body",
              html: true,
              trigger: "hover focus",
              placement: "auto",
              boundary: "viewport",
              delay: { show: 150, hide: 100 },
              sanitize: false,
              content: () => buildPopoverContent(card.__model),
            });
          });
        }

        // Delete call
        window.deleteModel = function deleteModel(modelId, modelName) {
          if (!confirm("Are you sure you want to delete this model?")) return;
          fetch("/delete-model", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model_id: modelId, model_name: modelName }),
          })
          .then(async (res) => {
            const data = await res.json().catch(() => ({ message: "Delete completed." }));
            if (!res.ok) throw new Error(data?.message || res.statusText);
            alert(data?.message || "Model deleted.");
            location.reload();
          })
          .catch((err) => {
            console.error("Delete failed:", err);
            alert("Failed to delete model.");
          });
        };

        // ===== Main =====
        async function main() {
          const models = await fetchModels();
          spinner?.classList.add("d-none");

          if (!models.length) {
            noModels?.classList.remove("d-none");
            return;
          }

          grid?.classList.remove("d-none");

          const frag = document.createDocumentFragment();
          models.forEach((m) => frag.appendChild(renderCard(m)));
          grid?.appendChild(frag);

          wireCardInteractions(grid);
          enablePopovers(grid);

        console.log([...document.querySelectorAll('.use-model-btn')].map(b=>b.dataset.modelId));
        }

        main();
      })();
    </script>
  </body>
</html>
